<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8"/>
    <title>trainigsplan</title>

    <style>
        .mobile_button button.mobile_button,  button.mobile_button {
           font-size: 35px;
           height: 5vh;
        }

        /*.mobile_p p.mobile_p,  p.mobile_p {
           font-size: 30px;
        }*/

        .mobile_span span.mobile_span,  span.mobile_span {
           font-size: 30px;
        }

        .mobile_label label.mobile_label,  label.mobile_label {
           font-size: 30px;
        }
    </style>

    <link rel="stylesheet" type="text/css" href="css/main.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.1/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@8"></script>
    <script src="js/node_modules/patternomaly/dist/patternomaly.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@1/dark.css">


    <script src="http://jakob.ml:8081/auth/js/keycloak.js"></script> 
    <script>
        var keycloak;

        function display_error(type, title, message)
        {
            var footer = '<hr style="height: 2px; background-color:#666;"><br>';

            console.log(message);

            if(message.includes('backend') && message.includes('unavailable') || message.includes('Authentification'))
                footer += message + '<br><br><a href onclick="location.reload()">Reload the Page!</button><br>';

            if(type == 'error')
                footer += '<a href="https://github.com/jkbngl/trainingsplan/issues/new">If you think this is not correct please open a github issue!</a>'
                
            footer += '<br><br><hr style="height: 2px; background-color:#666;"><br>';

            Swal.fire({
              type: type,
              customClass: mobile_swal,
              title: title,
              html: footer
            })
        }

        document.addEventListener('DOMContentLoaded',function(){
            try
            {
                swal.fire({
                    title: 'Loading your data...',
                    customClass: mobile_swal,
                    allowEscapeKey: false,
                    allowOutsideClick: false,
                    onOpen: () => {
                      swal.showLoading();
                    }
                });

                keycloak = Keycloak();

                keycloak.init({ onLoad: 'login-required' })

                keycloak.init().success(
                    function(authenticated) 
                    {
                        // alert(authenticated ? 'authenticated' : 'not authenticated');
                    }
                ).error(function() {
                    // alert('failed to initialize');
                });

                keycloak.onAuthSuccess = function() 
                { 
                    swal.close();
                    console.log('Successfully authenticated');
                
                    username = keycloak.idTokenParsed.preferred_username;
                    username = username.toLowerCase();
                    check_roles(keycloak.realmAccess.roles);
                
                    document.getElementById("username").innerHTML = username + ' <i class="fas fa-sign-out-alt"></i>';

                    build_page();                                        
                
                    if( isMobile.any() ) 
                        customize_mobile();
                    else
                        ;
                }
            }
            catch(err)
            {
                display_error("error", "Ooops...", "Error with Authentification, please try again at a later point");
                window.stop() 
            }
        });

        function getusername()
        {
            return username;
        }
    </script>
</head>
<body>
    <div class="fixed-background blue-gradient-bg"></div>

    <div id="mySidenav" class="sidenav" style="z-index:2;">
        <button id="open-nav-button" onclick="closeNav()"                      class="button" style="float:right; float:top; margin-right: 10%; margin-bottom: 15%" ><i class="fas fa-bars"></i></a>
        <!--<a href="#">About</a>-->
        <button onclick="window.location.href='index.html'" class="button" style="top: 10px; width:80%; margin-left: 10%;"><i class="fas fa-home"></i> Home</button>
        <button onclick="window.location.href='stats.html'" class="button" id="stats-button" style="top: 10px; width:80%; margin-left: 10%;"><i class="fas fa-chart-line"></i> Stats</button>
        
        <button onclick="restore_bm();" class="button" style="top: 10px; width:80%; margin-left: 10%; margin-top: 15%;"><i class="fas fa-trash-restore-alt"></i> Restore</button>
        <button onclick="download();" class="button" style="top: 10px; width:80%; margin-left: 10%;"><i class="fas fa-file-export"></i> Export</button>
        <button onclick="reset_settings();" class="button" style="top: 10px; width:80%; margin-left: 10%; margin-top: 15%;"><i class="fas fa-hammer"></i> Reset Settings</button>
        
        <div class="page__toggle" style="margin-left: 10%; margin-top: 12%;">
            <label class="toggle">
            <input id="simplify-ui" onchange="closeNav();" onclick="simplify_ui();" class="toggle__input" type="checkbox">
            <span class="toggle__label">
                <span class="toggle__text">Simple interface 
                    <i class="fas fa-info-circle" rel="tooltip" title="If the simple interface is active, you no longer can select the unit and the time of the day for you inputs, they will default to unit = cm and time of day = after waking up" id="info-step-2"></i>
                </span>
            </span>
            </label>
        </div>

        <div class="page__toggle" style="margin-left: 20%; margin-top: 7%;">
            <label class="toggle">
            <input id="unit-checkbox-ui" onclick="simplify_ui_partly();" class="toggle__input" type="checkbox">
            <span class="toggle__label">
                <span class="toggle__text">Show Unit 
                    <i class="fas fa-info-circle" rel="tooltip" title="If this checkbox is active you can still set the unit of your inputs but dont have to set the time of the day of your inputs" id="info-step-2"></i>
                </span>
            </span>
            </label>
        </div>

        <div class="page__toggle" style="margin-left: 20%; margin-top: 5%;">
            <label class="toggle">
            <input id="tod-checkbox-ui" onclick="simplify_ui_partly();" class="toggle__input" type="checkbox">
            <span class="toggle__label">
                <span class="toggle__text">Show Time of Day
                    <i class="fas fa-info-circle" rel="tooltip" title="If this checkbox is active you can still set the time of the day of your inputs but dont have to set the unit of your inputs" id="info-step-2"></i>
                </span>
            </span>
            </label>
        </div>

        <div class="page__toggle" style="margin-left: 10%; margin-top: 20%; margin-bottom: 20%">
            <label class="toggle">
            <input id="chart-type" onchange="closeNav();" onclick="clear_chart(); update_bm_chart(get_active_bms(false)); set_cookie('chart_type', 90); set_labels(); set_potentials_with_chart_change()" class="toggle__input" type="checkbox">
            <span class="toggle__label">
                <span class="toggle__text">Bar Chart 
                    <i class="fas fa-info-circle" rel="tooltip" title="Change between the normal line chart and the bar chart to analyze your data" id="info-step-2"></i>
                </span>
            </span>
            </label>
        </div>

        <p style="margin-left: 10%; margin-bottom: 5%; color:#00ad5f; font-family: Century Gothic; font-size: 125%">Show N Datapoints (beta):</p>
        <input type="number" id="n-datapoints-to-show" onkeydown="set_datapoints_chart(this)" class="input_bm" placeholder="&nbsp; N Datapoints ..." style="text-align:center; background: transparent; border-radius: 10px; border: 2px solid #00ad5f; color:#00ad5f; width: 80%; font-size: 18px; font-family: Century Gothic; height: 5%; width:80%; margin-left: 10%; margin-top: 2%"> 
        
        
        <button onclick="keycloak.logout('/trainingsplanorwhateveritdoesntworkanyway'); kc.logout()"class="button" style="top: 10px; width:80%; margin-left: 10%; margin-top: 20%"><i class="fas fa-sign-out-alt"></i> Logout</button>
        
    </div>

    <div id = "headerforbuttons" style="display: flex; justify-content: space-between; position:fixed; width:100%; z-index:1;">
        <button onclick="openNav()" class="button" style="top: 10px;"><i class="fas fa-bars"></i></span>
            <button onclick="window.location.href='index.html'" class="button" style="top: 10px;" ><i class="fas fa-home"></i> Home</button>
            <button onclick="save()" class="button" style="top: 10px;" ><i class="far fa-save"></i> Save</button>
            <button onclick="keycloak.logout()" class="button" value="username ..." id="username" style="top: 10px;"></button>
    </div>â€‹

    <div id="div-line-chart" style="position: relative; margin-top: 2.5%; height: 60vh; z-index: 0">
        <canvas id="line-chart" height="100"></canvas>
    </div>
    <button id="clear-potential" onclick="closeNav(); clear_potential(true)" class="button" style="display: inline-block; position: absolute; right: 0; margin-bottom: 4%; margin-right: 1%" >Clear Potential <!--<i style="display: inline-block;" class="fas fa-trash"></i>--></button>
    <button id="add-new-input" onclick="closeNav(); add_html_input(true)" class="button" style="width:20%; margin:auto;  display: table;margin: 0 auto; margin-bottom: 4%" >Add <i class="fas fa-plus-circle"></i></a> </button>


    <div id="container_bm">
       <!-- Here come all the dinamically created bms-->
    </div>
</body>

<script>
    // Object to store data for all actively displayed data in chart
    var active_bm = [

    ];

    // global variable to handle the creation and destruction of chart easily
    var chart;
    
    // global variable to handle the creation and destruction of different chart easily, line = default
    //var chart_type = 'line';

    // Here the class is set for the swal to use, depending on mobile or desktop, desktop leave empty - mobile is set in customize_mobile
    var mobile_swal = '';           

    // masterdata
    var uoms = [];
    var tods = [];
    var bms  = [];
    var potential_datasets = [];
    var history_bms;

    // #67 Newly added func
    function get_amount_inputs()
    {
        // Get the main_div with all the stats inside
        var main_div = document.getElementById('container_bm');

        // Divided by 4 because there are additionally 4 divs in the main divs
        var amount_stats = main_div.getElementsByTagName('div').length;

        return amount_stats / 4;
    }

    // #67 Newly added func
    function save()
    {
        var amount_stats = get_amount_inputs();
        var jsonData = {
            stats: []
        };
        var tod_filled = false;
        var uom_filled = false;
        var name_filled = false;
        var values_are_numeric = false;

        for(let i = 1; i <= amount_stats; i++)
        {
            jsonData.stats.push({ 
                "username" : getusername(),
                "name"     : document.getElementById("additional-info_" + i).querySelector("#value_name").value,
                "value"    : document.getElementById("additional-info_" + i).querySelector("#value_value").value,
                "note"     : document.getElementById("additional-info_" + i).querySelector("#note").value,
                "id"       : document.getElementById("additional-info_" + i).getAttribute('value'),
                "uom"      : document.getElementById("additional-info_" + i).querySelector("#select_1").options[document.getElementById("additional-info_" + i).querySelector("#select_1").selectedIndex].value,
                "tod"      : document.getElementById("additional-info_" + i).querySelector("#select_2").options[document.getElementById("additional-info_" + i).querySelector("#select_2").selectedIndex].value
            });
        }


        for(let i = 0; i < amount_stats; i++)
        {
            if(jsonData.stats[i].tod.length > 0)
            {
                tod_filled = true;
            }
            else
            {
                tod_filled = false;
            }

            if(jsonData.stats[i].uom.length > 0)
            {
                uom_filled = true;
            }
            else
            {
                uom_filled = false;
            }

            if(jsonData.stats[i].name.length > 0)
            {
                name_filled = true;
            }
            else
            {
                name_filled = false;
            }
            
            if(isNaN(jsonData.stats[i].value))
            {
                values_are_numeric = false;
            }
            else
            {
                values_are_numeric = true;
            }

            // If one values has an error - STOP
            if(!values_are_numeric || !tod_filled || !uom_filled || !name_filled)
                break;
        }

        //console.log(values_are_numeric + " | " + uom_filled + " | " + tod_filled + " | " + name_filled)
        
        if(document.getElementById("simplify-ui").checked)
        {
            // console.log("FULL SIMPLE INTERFACE active");

            if(values_are_numeric && name_filled)
            {
                // values have to be numeric as well here
                // TODO set unset tod and uoms to default values
                for(let i = 0; i < amount_stats; i++)
                {
                    if(jsonData.stats[i].tod.length <= 0)
                        jsonData.stats[i].tod = 'after waking up'
                    
                    if(jsonData.stats[i].uom <= 0)
                        jsonData.stats[i].uom = 'cm'
                }

                send_bm_data_to_backend(jsonData);
            }
            else
            {
                console.log("ERROR");

                if(!name_filled)
                    display_error('error', 'Enter a name for the bm!', 'dont know');
                else if(!values_are_numeric)
                    display_error('error', 'Values must be numeric and may not contain letters!', 'dont know');
            }
        }
        else if(document.getElementById("tod-checkbox-ui").checked && !document.getElementById("unit-checkbox-ui").checked)
        {
            // console.log("unit grayed out");

            if(values_are_numeric && name_filled && tod_filled)
            {
                // values have to be numeric as well here
                // TODO set unset tod and uoms to default values
                for(let i = 0; i < amount_stats; i++)
                {
                    if(jsonData.stats[i].uom.length <= 0)
                        jsonData.stats[i].uom = 'cm'; 
                }

                send_bm_data_to_backend(jsonData);
            }
            else
            {
                console.log("ERROR");
                swal.close();

                if(!name_filled && values_are_numeric && tod_filled)
                    display_error('error', 'Enter a name for the bm!', 'dont know');
                else if(!name_filled && !values_are_numeric && tod_filled)
                    display_error('error', 'Enter a name for the bm and values must be numeric and may not contain letters!', 'dont know');
                else if(!name_filled && !values_are_numeric && !tod_filled)
                    display_error('error', 'Enter a name for the bm, values must be numeric and may not contain letters and you have to select a time of the day!', 'dont know');
                else if(name_filled && !values_are_numeric && tod_filled)
                    display_error('error', 'Values must be numeric and may not contain letters!', 'dont know');
                else if(name_filled && !values_are_numeric && !tod_filled)
                    display_error('error', 'Values must be numeric and may not contain letters and you have to select a time of the day!', 'dont know');
                else if(name_filled && values_are_numeric && !tod_filled)
                    display_error('error', 'You have to select a time of the day!', 'dont know');
                else if(!name_filled && values_are_numeric && !tod_filled)
                    display_error('error', 'Enter a name for the bm and you have to select a time of the day!', 'dont know');
            }
        }
        else if(document.getElementById("unit-checkbox-ui").checked && !document.getElementById("tod-checkbox-ui").checked)
        {
            // console.log("tod grayed out");

            if(values_are_numeric && name_filled && uom_filled)
            {
                // values have to be numeric as well here
                // TODO set unset tod and uoms to default values
                for(let i = 0; i < amount_stats; i++)
                {
                    if(jsonData.stats[i].tod.length <= 0)
                        jsonData.stats[i].tod = 'after waking up'            
                }

                console.log(jsonData);

                send_bm_data_to_backend(jsonData);
            }
            else
            {
                console.log("ERROR");
                swal.close();


                // Maybe refactor to the same as in the else clause, with error_string and concatenating, for the user this is better, for the programmer the other one
                if(!name_filled && values_are_numeric && uom_filled)
                    display_error('error', 'Enter a name for the bm!', 'dont know');
                else if(!name_filled && !values_are_numeric && uom_filled)
                    display_error('error', 'Enter a name for the bm and values must be numeric and may not contain letters!', 'dont know');
                else if(!name_filled && !values_are_numeric && !uom_filled)
                    display_error('error', 'Enter a name for the bm, values must be numeric and may not contain letters and you have to select a unit!', 'dont know');
                else if(name_filled && !values_are_numeric && uom_filled)
                    display_error('error', 'Values must be numeric and may not contain letters!', 'dont know');
                else if(name_filled && !values_are_numeric && !uom_filled)
                    display_error('error', 'Values must be numeric and may not contain letters and you have to select a unit!', 'dont know');
                else if(name_filled && values_are_numeric && !uom_filled)
                    display_error('error', 'You have to select a unit!', 'dont know');
                else if(!name_filled && values_are_numeric && !uom_filled)
                    display_error('error', 'Enter a name for the bm and you have to select a unit!', 'dont know');
            }
        }
        else
        {
            // console.log("NO SIMPLE INTERFACE active")

            if(uom_filled && tod_filled && values_are_numeric && name_filled)
            {
                send_bm_data_to_backend(jsonData)
            }
            else
            {
                //console.log("ERROR");
                swal.close();

                var error_string = '';

                if(!uom_filled)
                    error_string += 'please select a unit and ';
                if(!tod_filled)
                    error_string += 'please select a time of the day and ';
                if(!values_are_numeric)
                    error_string += 'palues must be numeric and may not contain letters and ';
                if(!name_filled)
                    error_string += 'please enter a name for the bm and ';

                error_string = error_string.charAt(0).toUpperCase() + error_string.slice(1);

                display_error('error', error_string.substring(0, error_string.length - 5) + "!", 'dont know');

            }
        }
    }

    function set_datapoints_chart(data, force) 
    {
        if(event.key === 'Enter' || force)
        {

            // as it is a string + the chart starts at 0 not 1
            let val = parseInt(data.value) - 1;
            
            // reload the whole page, with only 
            on_save(val + 1);

            // let length = chart.data.datasets.length;
            // let chart_type = chart.optionstype;
            // 
            // chart.options.scales.xAxes[0].ticks.max = val;
            // for(let i = 0; i < length; i++)
            //     chart.data.datasets[i].data = chart.data.datasets[i].data.slice(-(val + 1));
            // 
            // console.log(chart.config.options.scales.xAxes[0].ticks.max)
            // 
            // chart.update();
        }
    }

    // #67 Newly added func
    function send_bm_data_to_backend(jsonData)
    {
        // POST, can not be replaced
        try
        {
            var xhr = new XMLHttpRequest();
            var url = "http://jakob.ml:8080/tpbackend_1-1.0-SNAPSHOT/api/trainingsplan/send_bm_values";
            xhr.open("POST", url, true);
            xhr.setRequestHeader("Content-Type", "text/plain");
            var string = JSON.stringify(jsonData);
            
            xhr.send(string);

            checkIfDataIsLoadedIntoDB(xhr);
        }
        catch(err)
        {
            console.error(err);
            display_error('error', 'Oops...', 'The backend seems to be unavailable!')
        }
    }

    // #67 Newly added func
    function checkIfDataIsLoadedIntoDB(xhr)
    {
        swal.fire({
          title: 'Saving your Data...',
          allowEscapeKey: false,
          customClass: mobile_swal,
          allowOutsideClick: false,
          onOpen: () => {
            swal.showLoading();
          }
        });

        var counter = 0;
        var check = function(){
            if(xhr.status == 200){
                console.log("POST worked, data send, reload page with new data: " + xhr.status + " - " + xhr.responseText);

                if(xhr.responseText == "ok")
                {
                    swal.fire({
                        title: 'Your bms were saved!',
                        type: 'success',
                        //position: 'top-end',
                        timer: 1000,
                        customClass: mobile_swal,
                        showCancelButton: false,
                        showConfirmButton: false
                    });
                }
                else if(xhr.responseText.includes("Same bm does already exist"))
                {
                    console.log("CATCHED")
                    display_error("error", xhr.responseText, "You entered a bm which is already existent in its unique combination");
                }
                
                
                on_save();
            }
            else if(xhr.status != 200 && xhr.status != 0)
            {
                swal.fire({
                    title: 'ERROR - ' + xhr.status + "!",
                    type: 'error',
                    //position: 'top-end',
                    customClass: mobile_swal,
                    timer: 5000,
                    showCancelButton: false,
                    showConfirmButton: false
                });
            }
            else if(counter >= 200) // After 20 (if check wait time is still 100) seconds of waiting, stop
            {
                display_error("error", "Ooops...", "The backend seems to be unavailable");
            }
            else {
                if(counter == 50)
                {
                    swal.fire({
                      title: 'This takes longer than usual, please be patient',
                      customClass: mobile_swal,
                      allowEscapeKey: false,
                      allowOutsideClick: false,
                      onOpen: () => {
                        swal.showLoading();
                      }
                    });
                }

                //console.log("waiting");
                counter++;
                setTimeout(check, 100); // check again in a second
            }
        }
        
        // If not waiting longe than 10 seconds
        if(counter < 100)
            check();
    }

    // #67 Newly added func
    function on_save(num)
    {
        var num_input = get_amount_inputs();

        document.getElementById("container_bm").innerHTML = '';
        
        clear_chart();  
        build_page(num);
    }

    // #67 Newly added func
    function set_labels()
    {
        // id which needs to be defined to get the metadata(hidden) of the lines/ bars
        var meta_data_id;
        // All bms to loop through them
        var all_bms = get_amount_inputs();
        // Amount of active to check if only one is active
        var active_bm = 0;
        // The name and the index of the active bm, gets overwritten when multiple are active, which does not matter as we then dont use it
        var name_active_bm;
        var index_active_bm;
        // Historic data to set the labels accordingly
        var historic_data;
        // If there is only one bm active anymore 
        var new_labels = [];
        // length of longest bm 
        var local_labels_numbers = [];
        // depends on bar and line chart
        var is_chart_active;

        for(var i = 0; i < all_bms; i++)
        {
            if(chart.config.type == 'line')
            {
                meta_data_id = chart.getDatasetMeta(i).controller.chart.id;
                is_chart_active = chart.data.datasets[i]['_meta'][meta_data_id].hidden;
            }
            else
            {
                var meta = chart.getDatasetMeta(i);
                is_chart_active = meta.data[0].hidden;
            }
            
            if(!is_chart_active)
            {
                active_bm++;
                name_active_bm = chart.data.datasets[i].label;

                if(chart.config.type == 'line')
                    index_active_bm = chart.data.datasets[i]['_meta'][meta_data_id].dataset._datasetIndex;
                else 
                    index_active_bm = i;

                local_labels_numbers.push(chart.data.datasets[i].data.length)
            } 
        }

        if(active_bm == 1)
        {
            historic_data = JSON.parse(rest_get_historical_bm(document.getElementById("additional-info_" + (index_active_bm + 1)).getAttribute("base_bm"), true));

            for(var i = 0; i < historic_data.length; i++)
            {
                var date = new Date(historic_data[i].created).toUTCString()
                date = date.split(' ').slice(1, 4).join(' ')

                new_labels.push(date);

                if(i == historic_data.length - 1)
                    new_labels.push("potential");
            }

            chart.data.labels = new_labels;
        }
        else
        {
            var max_num = Math.max.apply(Math, local_labels_numbers);
            local_labels_numbers = [];
                    
            for(var k = 0; k < max_num; k++)
                local_labels_numbers.push(k);

            local_labels_numbers.push("potential");

            chart.data.labels = local_labels_numbers;
        }

        chart.update();
    }

    // #67 newly added func
    function set_bm_as_deactivated_as_callback_from_chart(event, bm_name)
    {
        var meta_data_id = chart.getDatasetMeta(bm_name.datasetIndex).controller.chart.id;

        // At first its undefined so set it as defined at the beginnning
        if(chart.data.datasets[bm_name.datasetIndex]['_meta'][meta_data_id].hidden === false)
            chart.data.datasets[bm_name.datasetIndex]['_meta'][meta_data_id].hidden = false;   // At first it is always active, so set it to hidden true, which is active
        else
            ;

        if(chart.data.datasets[bm_name.datasetIndex]['_meta'][meta_data_id].hidden)
        {
            document.getElementById("additional-info_" + (bm_name.datasetIndex + 1)).querySelector("#active_box").checked = true;


            if(chart.config.type == 'line')
            {
                chart.data.datasets[bm_name.datasetIndex]['_meta'][meta_data_id].hidden = false;
                show_potential(bm_name.datasetIndex + 1);
            }
            else
            {
                chart.data.datasets[bm_name.datasetIndex]['_meta'][meta_data_id].hidden = false;
                var meta = chart.getDatasetMeta(bm_name.datasetIndex);
                meta.data[0].hidden = !meta.data[0].hidden;
                show_potential(bm_name.datasetIndex + 1);
            }

        }
        else if(!chart.data.datasets[bm_name.datasetIndex]['_meta'][meta_data_id].hidden)
        {
            // If the chart goes from the active state into hidden state
            clear_potential(false, chart.data.datasets[bm_name.datasetIndex].label);

            if(chart.config.type == 'line')
            {
                chart.data.datasets[bm_name.datasetIndex]['_meta'][meta_data_id].hidden = true;
            }
            else
            {
                chart.data.datasets[bm_name.datasetIndex]['_meta'][meta_data_id].hidden = true;
                var meta = chart.getDatasetMeta(bm_name.datasetIndex);
                meta.data[0].hidden = !meta.data[0].hidden;
            }

            document.getElementById("additional-info_" + (bm_name.datasetIndex + 1)).querySelector("#active_box").checked = false;
        }

        set_labels();

        chart.update();

        set_cookie('active', 90);
    }
    
    // #67 changed func
    function download() 
    {
        var amount_bms = get_amount_inputs();
                
        if(amount_bms > 0)
        {
            // Get the data to save the file with different names #
            // TODO read active_ex_in_chart and add ex names
            
            var url_base64 = document.getElementById('line-chart').toDataURL('image/png');
            var element = document.createElement('a');
            
            element.setAttribute('href', url_base64);
            element.setAttribute('download', 'chart_' + get_date() + '.png');
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }
        else
        {
            alert("Nothing to export!");
        }
    }

    function get_date()
    {
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
        var yyyy = today.getFullYear();

        return mm + '_' + dd + '_' + yyyy;
    }

    // #67 Newly added func
    function append_combo(div)
    {
        var json_uoms = rest_uoms();
        var json_tods = rest_tods();

        var s_1 = document.getElementById(div).querySelector("#select_1");
        var s_2 = document.getElementById(div).querySelector("#select_2");

        
        for(var i = 0; i < json_uoms.length; i++) 
        {
            var opt = document.createElement('option');
            opt.value = json_uoms[i];
            opt.innerHTML = json_uoms[i];
            opt.id = 'option_element';
            s_1.appendChild(opt);
        }

        for(var i = 0; i < json_tods.length; i++) 
        {            
            var opt = document.createElement('option');
            opt.value = json_tods[i];
            opt.innerHTML = json_tods[i];
            opt.id = 'option_element';
            s_2.appendChild(opt);
        }
    }
    
    // #67 Newly added func
    function rest_uoms()
    {
        // Has been refactored
        if(uoms.length == 0)
        {
            try
            {
                var request = new XMLHttpRequest();
                var url = 'http://jakob.ml:8080/tpbackend_1-1.0-SNAPSHOT/api/trainingsplan/get_uoms/';
                var xmlHttp = new XMLHttpRequest();

                xmlHttp.open( "GET", url, false ); // false for synchronous request
                xmlHttp.send( null );
                uoms = xmlHttp.responseText;
                uoms = JSON.parse(uoms);

                return uoms;
            }
            catch(err)
            {
                console.error(err);
                display_error('error', 'Oops...', 'The backend seems to be unavailable!')
            }
        }
        else
        {
            return uoms;
        }
    }

    // #67 Newly added func
    function rest_tods()
    {
        // Has been refactored
        if(tods.length == 0)
        {
            try
            {
                var url = 'http://jakob.ml:8080/tpbackend_1-1.0-SNAPSHOT/api/trainingsplan/get_tods/';
                var xmlHttp = new XMLHttpRequest();

                xmlHttp.open( "GET", url, false ); // false for synchronous request
                xmlHttp.send( null );
                tods = xmlHttp.responseText;
                tods = JSON.parse(tods);

                return tods;
            }
            catch(err)
            {
                console.error(err);
                display_error('error', 'Oops...', 'The backend seems to be unavailable!')
            }
        }
        else
        {
            return tods;
        }
    }

    // #67 Newly added func
    function add_html_input(via_button, id, active_or_not, name, value, select_uom, select_tod, note, base_bm)
    {
        //Give the new div a number which is the current amount + 1
        var num_input = get_amount_inputs() + 1;
        // Create a container that will be added to the div
        var container = document.createElement("div");
        container.setAttribute("id", "div_to_delete");
        
        if(via_button)
            id = "defaultvaluetoignore";

        container.innerHTML = '<div id="additional-info_' + num_input + '" value="' + id + '" base_bm="' + base_bm + '" style="width: 100%; margin-bottom: 3%; display: flex; flex-direction: row; flex-wrap: nowrap;justify-content: space-between;"> \
            <div id="check-2" class="page__toggle"  style="margin-top: 10px; margin: auto;  margin-left:1%; z-index:1;"> \
                <label class="toggle"> \
                    <input id="active_box" onchange="closeNav();" onclick="set_cookie(\'active\', 90); toggle_chart_datasets(); show_potential(' + num_input + ')"  class="toggle__input" type="checkbox" checked> \
                    <span class="toggle__label"> \
                        <span class="toggle__text">Active</span> \
                    </span> \
                </label> \
            </div> \
            \
            <input type="text" ' + ( via_button                   ? 'autofocus' : '') + ' id="value_name"  class="input_bm" placeholder="&nbsp; Enter the name of input value ..." style="text-align:center; background: transparent; border-radius: 25px; border: 2px solid #00ad5f; color:#00ad5f; width: 25%; font-size: 18px;font-family: Century Gothic; margin-right:2%; margin-left:2%; "> \
            <input type="number" ' + (!via_button && num_input <= 1 ? 'autofocus' : '') + ' onchange="show_potential(' + num_input + ')" id="value_value" class="input_bm" placeholder="&nbsp; Value of input ..."      style="text-align:center; background: transparent; border-radius: 25px; border: 2px solid #00ad5f; color:#00ad5f; width: 15%; font-size: 18px;font-family: Century Gothic; margin-right:2%"> \
            <input type="text" id="note" class="input_bm" placeholder="&nbsp; Note ..." style="text-align:center; background: transparent; border-radius: 25px; border: 2px solid #00ad5f; color:#00ad5f; width: 25%; font-size: 18px;font-family: Century Gothic; margin-right:2%; "> \
            \
            <div class="select" id="select-options_nr-1" style="border-bottom: 4px solid rgba(0,0,0, 0.12); border-right: 4px solid rgba(0,0,0, 0.12); margin-right: 5%"> \
                <select id= "select_1" onchange="closeNav();" class="select-text" required > \
                    <option value="" selected>select ...</option> \
                </select> \
                <span class="select-highlight"></span> \
                <label id="select-text" style="font-size: 22px; top: -30px;  right: -20px;" class="select-label">Unit \
                    <i class="fas fa-info-circle" rel="tooltip" title="Select a unit from this box, this might be cm, kg or foot, it tells you the unit of your input" id="info-unit-step-' + num_input + '"></i> \
                    </label> \
                <span class="select-bar"></span> \
            </div> \
             \
            <div class="select" id="select-options_nr-2" style="border-bottom: 4px solid rgba(0,0,0, 0.12); border-right: 4px solid rgba(0,0,0, 0.12); margin-right: 5%"> \
                <select id= "select_2" onchange="closeNav();" class="select-text" required > \
                    <option value="" selected>select ...</option> \
                </select> \
                <span class="select-highlight"></span> \
                <label id="select-text" style="font-size: 22px; top: -30px;  right: -20px;" class="select-label">Time of Day \
                <i class="fas fa-info-circle" rel="tooltip" title="Select a time of the day on which you will measure this input, our body varies a lot during the day so it is important to always choose the sime timings to see a trend in the data" id="info-tod-step-' + num_input + '"></i> \
                </label> \
                <span class="select-bar"></span> \
            </div> \
            <button class="button" id="visualize_progress_button" onclick="show_progress_dialog(' + num_input + ')" style="margin-right: 1%"><i class="fas fa-info-circle"></i></button> \
            <button class="button" id="delete_button" onclick="delete_and_reoder(' + num_input + ')" style="margin-right: 1%"><i class="fas fa-trash"></i></button> \
        </div>';

        document.getElementById("container_bm").appendChild(container);

        const node = document.getElementById("div_to_delete");
        node.replaceWith(...node.childNodes);

        append_combo("additional-info_" + num_input);

        if(!via_button)
        {
            document.getElementById("additional-info_" + num_input).querySelector("#value_name").value = name;
            document.getElementById("additional-info_" + num_input).querySelector("#value_name").disabled = true;
            document.getElementById("additional-info_" + num_input).querySelector("#value_name").style.color = "gray";

            document.getElementById("additional-info_" + num_input).querySelector("#value_value").value = value;
            document.getElementById("additional-info_" + num_input).querySelector("#note").value = note;

            document.getElementById("additional-info_" + num_input).querySelector("#select_1").value = select_uom;
            //document.getElementById("additional-info_" + num_input).querySelector("#select_1").disabled = true;

            document.getElementById("additional-info_" + num_input).querySelector("#select_2").value = select_tod;
            //document.getElementById("additional-info_" + num_input).querySelector("#select_2").disabled = true;
        }

        if(document.getElementById("simplify-ui").checked)
        {
            document.getElementById("additional-info_" + num_input).querySelector("#select-options_nr-1").style.display = "none";
            document.getElementById("additional-info_" + num_input).querySelector("#select-options_nr-2").style.display = "none";
        }
        else if(document.getElementById("unit-checkbox-ui").checked && !document.getElementById("tod-checkbox-ui").checked)
        {
            document.getElementById("additional-info_" + num_input).querySelector("#select-options_nr-2").style.display = "none";
        }
        else if(document.getElementById("tod-checkbox-ui").checked && !document.getElementById("unit-checkbox-ui").checked)
        {
            document.getElementById("additional-info_" + num_input).querySelector("#select-options_nr-1").style.display = "none";
        }
    }

    Array.prototype.equals = function (array) {
        // if the other array is a falsy value, return
        if (!array)
            return false;

        // compare lengths - can save a lot of time 
        if (this.length != array.length)
            return false;

        for (var i = 0, l=this.length; i < l; i++) {
            // Check if we have nested arrays
            if (this[i] instanceof Array && array[i] instanceof Array) {
                // recurse into the nested arrays
                if (!this[i].equals(array[i]))
                    return false;       
            }           
            else if (this[i] != array[i]) { 
                // Warning - two different object instances will never be equal: {x:20} != {x:20}
                return false;   
            }           
        }       

        return true;
    }

    // #67 newly added func
    function show_potential(num_bm)
    {
        
        // get the send bms
        var active_bms = get_active_bms(false);
        // Amount of elements in the currentyl active bms
        var num_last_elem;
        // All historic values of the bm
        var current_active_values = [];
        // change background for potential depending on chart type
        var background_attribute;
        // to keep track which potentials where already added
        var same_potential_was_already_added = false;
        //
        var potential_label = document.getElementById('additional-info_' + num_bm).querySelector("#value_name").value;

        var t0 = performance.now();

        i = num_bm - 1;

        
        // Has to be done inside loop because of i, which needs to color of the related bm
        if(chart.config.type == 'line')
            background_attribute = border_color_array[i]
        else if(chart.config.type == 'bar')
            background_attribute = pattern.draw('zigzag', border_color_array[i])

        // get the last value of the bm, the current one
        var bm = JSON.parse(active_bms[i])
        num_last_elem = bm.length - 1;

        if(bm[num_last_elem].value != document.getElementById("additional-info_" + (i + 1)).querySelector("#value_value").value && document.getElementById("additional-info_" + (i + 1)).querySelector("#active_box").checked)
        {
            
            if(chart.config.type == 'line')
                for(var j = 0; j < num_last_elem + 1; j++)
                    current_active_values.push(bm[j].value);
            else if(chart.config.type == 'bar')
                for(var j = 0; j < num_last_elem + 1; j++)
                    current_active_values.push(0);

            current_active_values.push(document.getElementById("additional-info_" + (i + 1)).querySelector("#value_value").value);

            for(var k = 0; k < chart.data.datasets.length; k++)
            {
                if(chart.data.datasets[k].label.startsWith("potential for " + potential_label))
                {
                    if(chart.data.datasets[k].data.equals(current_active_values))
                    {
                        same_potential_was_already_added = true;
                        //break;
                    }
                    else
                    {

                    }
                }
            }

            if(document.getElementById('n-datapoints-to-show').value.length > 0)
            {
                let val = document.getElementById('n-datapoints-to-show').value;

                current_active_values = current_active_values.slice(-(val));

            }    

            if(!same_potential_was_already_added)
            {
                chart.data.datasets.push({
                    data: current_active_values,
                    label: 'potential for ' + document.getElementById("additional-info_" + (i + 1)).querySelector("#value_name").value + ' [' + document.getElementById("additional-info_" + (i + 1)).querySelector("#select_1").value + '] - ' + document.getElementById("additional-info_" + (i + 1)).querySelector("#select_2").value,
                    borderColor: border_color_array[i],
                    backgroundColor: background_attribute,
                    borderDash: [10],
                    fill: false
                });
            }

            // Set the animation duration to 0 to not show that a new dataset has been added to chart 
            var old_animation_duration = chart.options.animation.duration;
            chart.options.animation.duration = 0;
            chart.update();
            // Set it back to the old value
            chart.options.duration = old_animation_duration;    
            
            // Clean at the end
            current_active_values = [];
        }

        var t1 = performance.now();
        if((t1 - t0) > 100)
            console.log("Calculating potential took: " + (t1 - t0) + " milliseconds.")

    }

    // #67  newly added func
    function set_cookie(cname, exdays) 
    {
        var d = new Date();
        d.setTime(d.getTime() + (exdays*24*60*60*1000));
        var expires = "expires=" + d.toGMTString();

        // Dont comment in, only in case all coockies should be deleted, for testing purpose - should never be commented in in production
            //delete_all_cookies();

        if(cname == 'active')
        {
            var amount_days = get_amount_inputs();

            for(var i = 0; i < amount_days; i++)
            {
                document.cookie = cname + "_"+ i + "=" + document.getElementById("additional-info_" + (i + 1)).querySelector("#active_box").checked + ";" + expires + ";path=/";
            }    
        }
        else if(cname == 'chart_type')
        {
            document.cookie = cname + "=" + chart.config.type + ";" + expires + ";path=/";
        }
        else if(cname == 'interface_type')
        {
            if(document.getElementById("simplify-ui").checked)
            {
                document.cookie = cname + "=simple_interface;" + expires + ";path=/";
            }
            else if(document.getElementById("unit-checkbox-ui").checked && !document.getElementById("tod-checkbox-ui").checked)
            {
                document.cookie = cname + "=simple_with_unit;" + expires + ";path=/";
            }
            else if(document.getElementById("tod-checkbox-ui").checked && !document.getElementById("unit-checkbox-ui").checked)
            {
                document.cookie = cname + "=simple_with_tod;" + expires + ";path=/";
            }
            else if(document.getElementById("tod-checkbox-ui").checked && document.getElementById("unit-checkbox-ui").checked)
            {
                document.cookie = cname + "=advanced_interface;" + expires + ";path=/";
            }
            else
            {
                document.cookie = cname + "=advanced_interface;" + expires + ";path=/";
            }
        }        
    }

    // #67  newly added func
    function delete_all_cookies() 
    {
        document.cookie.split(";").forEach(function(c) { document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); });
    }

    // #67 changed func
    function get_cookie(cname, index) 
    {
        // the active cookies can be more than one so we need to add the index
        if(cname == 'active_')
            var name = cname + index + "=";
        else
            var name = cname + "=";

        var decodedCookie = decodeURIComponent(document.cookie);
        var ca = decodedCookie.split(';');
        
        for(var i = 0; i < ca.length; i++) 
        {
            var c = ca[i];

            while (c.charAt(0) == ' ') 
            {
                c = c.substring(1);
            }

            if (c.indexOf(name) == 0) 
            {
                var cookie_val = c.substring(name.length, c.length);

                if(cname == 'active_')
                {
                    // Set the active cookies
                    set_dataset_and_button(index, cookie_val);
                }
                else if(cname == 'interface_type')
                {
                    if(cookie_val == 'simple_interface')
                    {
                        document.getElementById("simplify-ui").checked = true;
                        simplify_ui();
                    }
                    else if(cookie_val == 'simple_with_unit')
                    {
                        document.getElementById("unit-checkbox-ui").checked = true;
                        simplify_ui_partly();
                        
                    }
                    else if(cookie_val == 'simple_with_tod')
                    {
                        document.getElementById("tod-checkbox-ui").checked = true;
                        simplify_ui_partly();
                    }
                    else if(cookie_val == 'advanced_interface')
                    {
                        document.getElementById("tod-checkbox-ui").checked = true;
                        document.getElementById("unit-checkbox-ui").checked = true;
                    }

                }
                else if(cname == 'chart_type')
                {
                    // if the chart_type is bar set it to active, default is inactive which is line chart
                    if(cookie_val == 'bar')
                    {
                        document.getElementById("chart-type").checked = true;
                        chart_type = 'bar';
                    }    

                    // Then update the chart
                    clear_chart()
                    update_bm_chart(get_active_bms(true));
                    set_labels();
                }
            }
        }          
    }

    // #67  newly added func
    function set_dataset_and_button(index, bool)
    {
        var meta_data_id = chart.getDatasetMeta(index).controller.chart.id;

        // String does not work so I need to parse it to a javascript object
        var myBool = JSON.parse(bool);
        
        document.getElementById("additional-info_" + (index + 1)).querySelector("#active_box").checked = myBool;
        chart.data.datasets[index]['_meta'][meta_data_id].hidden = !myBool;    // Hidden so turn it around
        
        var meta = chart.getDatasetMeta(index);
        meta.data[0].hidden = !myBool;

        // In order that it is displayed correctly in the chart I need to update the chart so that it is also visible not only in the background
        chart.update();
    }

    // #67  newly added func
    function toggle_chart_datasets()
    {
        var length = get_amount_inputs();

        for(var i = 0; i < length; i++)
        {
            var meta_data_id = chart.getDatasetMeta(i).controller.chart.id;

            if(!document.getElementById("additional-info_" + (i + 1)).querySelector("#active_box").checked)
            {
                chart.data.datasets[i]['_meta'][meta_data_id].hidden = true;

                if(chart.config.type == 'bar')
                {
                    var meta = chart.getDatasetMeta(i);
                    meta.data[0].hidden = true;
                }

                // clear the potential of the bm as well and not only the active - the ones which are not active
                clear_potential(false, chart.data.datasets[i].label);
            }
            else
            {
                if(chart.config.type == 'bar')
                {
                    var meta = chart.getDatasetMeta(i);
                    meta.data[0].hidden = false;
                }

                chart.data.datasets[i]['_meta'][meta_data_id].hidden = false;
            }

            set_labels();            

            chart.update();
        }
    }

    // 67 newly added function
    function delete_and_reoder(num_to_delete)
    {
        var current_active_amount = get_amount_inputs();
        document.getElementById("additional-info_" + num_to_delete).remove();

        // If the last one was deleted nothing needs to be changed
        if(num_to_delete == current_active_amount)
        {
            //console.log("nothing to reorder")
            ;
        }    
        else
        {
            for(var i = num_to_delete; i <= current_active_amount; i++)
            {
                //console.log("current_active_amount: " + current_active_amount + " | num_to_delete: " + num_to_delete + " | i: " + i)
                
                // 1 can not be set to 0
                if(i > 1)
                {
                    if(document.body.contains(document.getElementById("additional-info_" + i)))
                    {
                        document.getElementById("additional-info_" + i).id = "additional-info_" + (i - 1);
                        document.getElementById("additional-info_" + (i - 1)).querySelector("#delete_button").setAttribute( "onClick","delete_and_reoder(" + (i - 1) + ");");
                    } 
                }       
            }
        }
        
        // if all were deleted add one so that anytime at least one is active
        if(get_amount_inputs() == 0)
        {
            add_html_input(true);
        }
    
    }

    // #67 Newly added func
    function build_page(num)
    {
        // empty String bms which will in case there are any contain the json object with the bms in it
        var bms = '';

        bms = rest_get_bms();

        if(bms.length > 0)
        {
            // Load his bms from the backend into the frontend
            for(var i = 0; i < bms.length; i ++)
            {
                add_html_input(false, bms[i].id, true, bms[i].value_name, bms[i].value, bms[i].uom, bms[i].tod, bms[i].note, bms[i].base_bm_value)
            }
        }
        else
        {
            // Add one single new when the user has none yet
            add_html_input(true);
        }

        active_bm = [];

        active_bm = get_active_bms(true, num);

        update_bm_chart(active_bm);

        // TODO load from cookies if active or not
        var length = get_amount_inputs();
        
        for(var i = 0; i < length; i++)
            get_cookie("active_", i);

        set_labels();
        set_selects_disabled();
        
        get_cookie('interface_type');
        get_cookie('chart_type');

        chart.update()
    }

    // #67 newly added func
    function set_selects_disabled()
    {
        var length = get_amount_inputs();

        if(length == 1 && document.getElementById("additional-info_" + 1).querySelector("#value_name").value.length == 0)
        {
            ;
        }
        else
        {
            for(var i = 1; i <= length; i++)
            {
                document.getElementById("additional-info_" + i).querySelector("#select_1").disabled = true;
                document.getElementById("additional-info_" + i).querySelector("#select_2").disabled = true;
            }
        }
        
    }

    // #67 newly added func
    function get_active_bms(force, num)
    {
        var amount_bms = get_amount_inputs();
        active_bm = [];

        for(var i = 1; i <= amount_bms; i++)
        {
            if(num > 0)
                active_bm.push(JSON.stringify(JSON.parse(rest_get_historical_bm(document.getElementById("additional-info_" + i).getAttribute("base_bm"), force)).slice(-(num))));
            else
                active_bm.push(rest_get_historical_bm(document.getElementById("additional-info_" + i).getAttribute("base_bm"), force));
            
            // console.log(JSON.parse(rest_get_historical_bm(document.getElementById("additional-info_" + i).getAttribute("base_bm"), force)).slice(-10));
            // console.log(JSON.parse(active_bm[i - 1]).slice(-10));
            //active_bm[i - 1] = JSON.parse(active_bm[i - 1]).slice(-10);
        }

        //console.log(active_bm);
        
        return active_bm;
    }

    // #67 Newly added func
    function rest_get_bms()
    {
        // Load of this data can not be replaced, because its dynamically and if a new bm is added or one is deleted we have to load them all again
        // might work with a changed flag
        try
        {
            var url = 'http://jakob.ml:8080/tpbackend_1-1.0-SNAPSHOT/api/trainingsplan/get_bm_values/';
            var xmlHttp = new XMLHttpRequest();
        
            xmlHttp.open( "GET", url + getusername() + "/0", false ); // false for synchronous request
            xmlHttp.send( null );
            bms = xmlHttp.responseText;
            
            bms = JSON.parse(bms);

            return bms;
        }
        catch(err)
        {
            console.error(err);
            display_error('error', 'Oops...', 'The backend seems to be unavailable!')
        }
    }

    // #67 newly added func
    function show_progress_dialog(num_bm)
    {
        // Get the base_bm_id of the clicked bm
        var bm_id = document.getElementById("additional-info_" + num_bm).getAttribute("base_bm");
        var json_history_bm = JSON.parse(rest_get_historical_bm(bm_id), false);
        var bm_name = document.getElementById("additional-info_" + num_bm).querySelector("#value_name").value


        Swal.fire({
            html:  parse_base_bm(json_history_bm, bm_name)
          , customClass: mobile_swal
        });
    }

    // #67 newly added func
    function parse_base_bm(json_bm, bm_name)
    {
        //  to_dispay += '<font color="green">Reps: ' + json.values[i].reps + "</font><br>";
        var to_dispay = "<h2>" + bm_name.toUpperCase() + " [" + json_bm[0].uom + "]" + " - " + json_bm[0].tod + "</h2><br><br>";

        for(var i = 0; i < json_bm.length; i++)
        {
            var date = new Date(json_bm[i].created).toUTCString()
            to_dispay += (i + 1) + ". Entry on: " + date.split(' ').slice(1, 4).join(' ') + "<br>";

            if(i > 0)
                if(json_bm[i].value > json_bm[i - 1].value)
                {
                    to_dispay += '<font color="green">' + json_bm[i].value + (json_bm[i].note.length != 0 ? "<br>Note:" + json_bm[i].note : "") + "</font><br>";
                }    
                else if(json_bm[i].value < json_bm[i - 1].value)
                {
                    to_dispay += '<font color="red">' + json_bm[i].value + (json_bm[i].note.length != 0 ? "<br>Note:" + json_bm[i].note : "") + "</font><br>"; 
                }
                else
                {
                    to_dispay += '<font color="white">' + json_bm[i].value + (json_bm[i].note.length != 0 ? "<br>Note:" + json_bm[i].note : "") + "</font><br>"; 
                }
            else
                to_dispay += '<font color="white">' + json_bm[i].value + (json_bm[i].note.length != 0 ? "<br>Note:" + json_bm[i].note : "") + "</font><br>"; 
        } 
        
        return to_dispay;
    }

    // #67 newly added func
    function clear_potential(full, bm_id)
    {
        if(full)
        {
            // Remove all datasets with the configured chart name
            chart.data.datasets = chart.data.datasets.filter(function(obj) {
                return (!obj.label.includes('potential for')); 
            });
        }
        else
        {
            console.log("going to clear: " + bm_id)
            // Remove only the datasets defined in the function call
            chart.data.datasets = chart.data.datasets.filter(function(obj) {
                return (obj.label != 'potential for ' + bm_id); 
            });
        }

        chart.update();   
    }

    // #67 Newly added func
    function rest_get_historical_bm(bm_id, force)
    {
        // Load of this data can not be replaced, because its dynamically and if a new bm is added or one is deleted we have to load them all again
        // might work with a changed flag
        if(bm_id == 'undefined')
        {
            return "[{}]"
        }
        else
        {
            if(true)
            {
                try
                {
                    var url = 'http://jakob.ml:8080/tpbackend_1-1.0-SNAPSHOT/api/trainingsplan/get_historical_bm_values/';
                    var xmlHttp = new XMLHttpRequest();

                    xmlHttp.open( "GET", url + getusername() + "/" + bm_id, false ); // false for synchronous request
                    xmlHttp.send( null );
                    history_bms = xmlHttp.responseText;

                    return history_bms;
                }
                catch(err)
                {
                    console.error(err);
                    display_error('error', 'Oops...', 'The backend seems to be unavailable!')
                }
            }
            else
            {
                return history_bms;
            }
        }
    }

    // #67 changed function
    function clear_chart()
    {
        // store the potentials before clearing the dataset
        let length = chart.data.datasets.length;
        potential_datasets = [];

        for(let i = 0; i < length; i++)
        {
            if(chart.data.datasets[i].label.startsWith("potential for"))
            {
                potential_datasets.push([chart.data.datasets[i],  chart.data.datasets[i]])
            }
        }

        chart.reset();
        chart.clear();
        chart.destroy();

        if(document.getElementById("chart-type").checked)
            chart = create_chart("bar");
        else
            chart = create_chart('line');

        return chart;
    }

    // #67 Newly added func
    function update_bm_chart(bms)
    {
        if(document.getElementById("chart-type").checked)
            chart = create_chart("bar");
        else
            chart = create_chart("line");

        var values = [];
        var bm_name = '';
        // If one ex active show dates of active
        var local_labels_date = [];
        // if multiple ex active show amount of datapoints
        var local_labels_numbers = [];

        for(var i = 0; i < bms.length; i++)
        {
            parsed_bm = JSON.parse(bms[i]);

            for(var j = 0; j < parsed_bm.length; j++)
            {
                values[j] = parsed_bm[j].value;                

                dateString = new Date(parsed_bm[j].created).toUTCString();
                //local_labels_date.push(dateString.split(' ').slice(1, 4).join(' '));

                // console.log(parsed_bm[j].uom);
                // console.log(parsed_bm[j].tod);

                // Once
                if(j == 0)
                {
                    bm_name = parsed_bm[j].value_name;
                    bm_uom = parsed_bm[j].uom;
                    bm_tod = parsed_bm[j].tod;

                    bm_legend_name = bm_name + " [" + bm_uom + "]" + " - " + bm_tod;
                    
                    //local_labels_numbers.push(parsed_bm.length);
                }
            }

            //local_labels_date.push("potential");

            chart.data.datasets.push({
                data: values,
                label: bm_legend_name,
                borderColor: border_color_array[i],
                backgroundColor: border_color_array[i],
                fill: false
            });

            // Needs to be done before as well to make sure that we can read the meta from this dataset
            chart.update();

            if(!document.getElementById("additional-info_" + (i + 1)).querySelector("#active_box").checked)
            {
                var meta_data_id = chart.getDatasetMeta(i).controller.chart.id;
                chart.data.datasets[i]['_meta'][meta_data_id].hidden = true;

                var meta = chart.getDatasetMeta(i);
                meta.data[0].hidden = !meta.data[0].hidden;

                chart.update();
            }            

            // Clear for next bm
            values = [];
            bm_name = '';
        }

        refill_potential();
        chart.update();
    }

    // #67 newly added func
    function set_potentials_with_chart_change()
    {
        var length = chart.data.datasets.length;

        for(let i = 0; i < length; i++)
        {
            var label = chart.data.datasets[i].label;
            //console.log(chart.data.datasets[i].data);

            if(label.startsWith("potential for"))
            {
                if(chart.config.type == 'bar')
                {
                    for(let j = 0; j < chart.data.datasets[i].data.length - 1; j++)
                        chart.data.datasets[i].data[j] = 0;
                }
                else if(chart.config.type == 'line')
                {
                    // Find correct bm, and fill datapoints which are zero with correct datapoints
                    var label_without_potential = label.substring(14);

                    for(let j = 0; j < chart.data.datasets.length; j++)
                    {
                        //console.log(label_without_potential)

                        if(chart.data.datasets[j].label == label_without_potential)
                        {
                            // set the correct datapoints
                            for(let k = 0; k < chart.data.datasets[i].data.length - 1; k++)
                                chart.data.datasets[i].data[k] = chart.data.datasets[j].data[k];

                            // set the background color because in the bar chart it has this zigged pattern while in line it is just "dashed"
                            chart.data.datasets[i].backgroundColor = chart.data.datasets[j].backgroundColor;

                            break;
                        }
                    }
                }
            }
        }
    
        chart.update();
    }

    
    function refill_potential()
    {
        for(let i = 0; i < potential_datasets.length; i++)
        {
            if(chart.config.type == 'line')
            {
                background_attribute = potential_datasets[i][1].backgroundColor
                
                chart.data.datasets.push({
                    data: potential_datasets[i][1].data,
                    label: potential_datasets[i][1].label,
                    borderColor: potential_datasets[i][1].borderColor,
                    backgroundColor: background_attribute,
                    borderDash: [10],
                    fill: false
                });
            }    
            else if(chart.config.type == 'bar')
            {
                background_attribute = pattern.draw('zigzag', potential_datasets[i][0].backgroundColor)

                chart.data.datasets.push({
                    data: potential_datasets[i][0].data,
                    label: potential_datasets[i][0].label,
                    borderColor: potential_datasets[i][0].borderColor,
                    backgroundColor: background_attribute,
                    borderDash: [10],
                    fill: false
                });
            }
        }
    }

    // #67 changed func
    function check_roles(assigned_roles)
    {
        var roles = [];
        var pos = 0;

        for(var i = 0; i < assigned_roles.length; i++)
        {
            if(assigned_roles[i] != 'admin' && assigned_roles[i] != 'offline_access' && assigned_roles[i] != 'uma_authorization' && assigned_roles[i] != 'user')
            {
                roles[pos] = assigned_roles[i];
                pos++;
            }
        }

        var superaccount = (roles.indexOf("friend_account") > -1) || (roles.indexOf("paid_account") > -1);

        console.log(roles);

        if(!superaccount)
        {
            if(roles.includes("bm_it_access") != true)
            {
                alert("Access denied!");
                window.location.href='index.html';
            }
            else if(roles.includes("stats_access") != true)
            {
                document.getElementById("stats-button").style.display = "none";
            }
            else
            {
                ;
            }
        }
    }


    // #67 changed func
    function restore_bm()
    {
        var deleted_bms = load_deleted_bm();
        var parsed_bms = {};

        for(var i = 0; i < deleted_bms.length; i++)
        {
            var date = new Date(deleted_bms[i].created).toUTCString()
            date = date.split(' ').slice(1, 5).join(' ');

            var columnName = deleted_bms[i].base_bm_value;
            parsed_bms[columnName] = date + ' - ' +  deleted_bms[i].value_name;
        }


        const {value: fruit} = Swal.fire({
            title: 'Select a bm',
            input: 'select',
            inputOptions: parsed_bms,
            inputPlaceholder: 'Select a bm...',
            customClass: mobile_swal,
            showCancelButton: true,
            
            inputValidator: (value) => {
                return new Promise((resolve) => 
                {
                    //console.log(value);

                    if(!isNaN(parseFloat(value)) && !isNaN(value - 0))
                    {
                        // POST, can not be replaced
                        var xhr = new XMLHttpRequest();
                        var url = "http://jakob.ml:8080/tpbackend_1-1.0-SNAPSHOT/api/trainingsplan/restore_bm";
                        xhr.open("POST", url, true);
                        xhr.setRequestHeader("Content-Type", "text/plain");

                        xhr.send(value);
                        on_save();
                    }
                    else
                    {
                        console.log("nothing selected");
                    }
                    
                    // As I am not using the await keyword, close it with this
                    swal.close();
                })
            }
        });
        
    }
    
    // #67 changed func
    function load_deleted_bm()
    {
        // Load of this data can not be replaced, because its dynamically and if a new bm is added or one is deleted we have to load them all again
        // might work with a changed flag
        try
        {
            var url = 'http://jakob.ml:8080/tpbackend_1-1.0-SNAPSHOT/api/trainingsplan/get_bm_values/';
            var xmlHttp = new XMLHttpRequest();
        
            xmlHttp.open( "GET", url + getusername() + "/1", false ); // false for synchronous request
            xmlHttp.send( null );
            bms = xmlHttp.responseText;
        
            return JSON.parse(bms);
        }
        catch(err)
        {
            console.error(err);
            display_error('error', 'Oops...', 'The backend seems to be unavailable!')
        }
    }

    // #67 still used func
    function does_json_contain_data(object) 
    {
        for(var i in object)
        {
            return true;
        }
        
        return false; 
    } 

    var labels = [1,2,3,4,5,6,7,8];
    var border_color_array = [ "#18AD5F" // green
                             , "#BD000A" // burning red
                             , "#102542" // dark blue
                             //, "#F7B32B" // yellow
                             //, "#0EB1D2" // very light blue
                             , "#4b081a" // bordeaux red
                             , "#0D1321" // dark blue
                             , "#f63f01" // orange
                             //, "#F9F7F3" // white 
                             ];
    
    // #67 changed func
    function create_chart(chart_type, num_datapoints)
    {       
        if(typeof chart_type == 'undefined')
            chart_type = 'line';
        
        if(typeof num_datapoints == 'undefined')
            num_datapoints = 50;

        var chart = new Chart(document.getElementById("line-chart"), {
            type: chart_type,
            data: {
                labels: labels,
                datasets: [

                ],
            },
            options: {
                line:
                {
                    fill: true
                },
                hidden: false,
                ticks: {
                    beginAtZero: false,
                    min: 0,
                    max: 5.03,
                    stepSize: 1,
                    padding: 10,
                    fontFamily: 'Karla, sans-serif',
                    maxRotation: 0
                },
                title: {
                    display: false,
                    text: 'Trainingsplan'
                },
                legend: {
                    display: true,
                    onClick: (event, legendItem, third) => set_bm_as_deactivated_as_callback_from_chart(event, legendItem),
                    labels: {
                        fontSize: 20,
                        filter: function(item, chart) {
                            // Logic to remove a particular legend item
                            return !item.text.includes('potential for');
                        }   
                    }
                },
                tooltips: {
                    filter: function (tooltip_item, all_items) 
                    {
                        // Check how this can be solved, show on last index but not on the others
                        return !all_items.datasets[tooltip_item.datasetIndex].label.includes("potential_for");
                    }
                },
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        }
                    }],
                    xAxes: [{
                        ticks: {
                            autoSkip: true,
                            autoSkipPadding: 8,
                            beginAtZero: true,
                            min: 0,
                            max: 50,
                            // type: 'time',
                            // distribution: 'linear'
                        }
                    }]
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });

        return chart;
    }

    // #67 still used func
    function openNav()
    {
        if( isMobile.any() ) 
        {
            document.getElementById("mySidenav").style.width = "300px";
        }
        else
        {
            document.getElementById("mySidenav").style.width = "250px";
        }   
    }
    // #67 still used func
    function closeNav()
    {
        document.getElementById("mySidenav").style.width = "0";
    }
    
    // #67 still used func
    var isMobile = {
        Android: function() {
            return navigator.userAgent.match(/Android/i);
        },
        BlackBerry: function() {
            return navigator.userAgent.match(/BlackBerry/i);
        },
        iOS: function() {
            return navigator.userAgent.match(/iPhone|iPad|iPod/i);
        },
        Opera: function() {
            return navigator.userAgent.match(/Opera Mini/i);
        },
        Windows: function() {
            return navigator.userAgent.match(/IEMobile/i) || navigator.userAgent.match(/WPDesktop/i);
        },
        any: function() {
            return (isMobile.Android() || isMobile.BlackBerry() || isMobile.iOS() || isMobile.Opera() || isMobile.Windows());
        }
    };

    // #67 still used func
    function customize_mobile(after_startup)
    {
        mobile_swal = 'mobile_swal';

        document.getElementById("headerforbuttons").style.height = "100px";
        chart.options.legend.labels.fontSize = 30;

        document.getElementById("div-line-chart").style.marginTop = "5%";
        document.getElementById("clear-potential").innerHTML = "Potential <i style='display: inline-block;' class='fas fa-trash'></i>";
        document.getElementById("clear-potential").style.fontSize = "28px";
        document.getElementById("add-new-input").style.fontSize = "28px";
        document.getElementById("additional-info_1").style.marginTop = "2%";

        if(after_startup)
        {
            console.log("customized");
            //document.getElementById("progress-text").style.fontSize = "30px";
            
            /*
            if(document.getElementById("info-progress"))
                document.getElementById("info-progress").remove();
                */
        }


        var buttons = document.getElementsByTagName("button");
        for(var i = 0, il = buttons.length; i < il; i++)
        {
            buttons[i].className += " mobile_button";
        }

        var spans = document.getElementsByTagName("span");
        for(var i = 0, il = spans.length; i < il; i++)
        {
            spans[i].className += " mobile_span";
        }

        var ps = document.getElementsByTagName("p");
        for(var i = 0, il = ps.length; i < il; i++)
        {
            ps[i].className += " mobile_p";
        }

        var labels = document.getElementsByTagName("label");
        for(var i = 0, il = labels.length; i < il; i++)
        {
            //labels[i].className += " mobile_label";
        }
    }

    // #67 newly added func
    function reset_settings()
    {
        document.getElementById("simplify-ui").checked = false;

        simplify_ui();

        document.getElementById("n-datapoints-to-show").value = '';
        set_datapoints_chart("", true);
    }

    // #67 changed func
    function simplify_ui()
    {
        var length = get_amount_inputs();

        document.getElementById("tod-checkbox-ui").checked = false;
        document.getElementById("unit-checkbox-ui").checked = false;

        if(document.getElementById("simplify-ui").checked)
        {   

            for(var i = 1;  i <= length; i++)
            {
                document.getElementById("additional-info_" + i).querySelector("#select-options_nr-1").style.display = "none";
                document.getElementById("additional-info_" + i).querySelector("#select-options_nr-2").style.display = "none";
            }

            /*       
            // document.getElementById("selects").style.width = "30%";
            document.getElementById("selects").style.marginLeft = "38%";

            document.getElementById("checks").style.display = "none";
            document.getElementById("factors").style.display = "none";
            //  document.getElementById("additional-info").style.display = "none";
            */
        }    
        else
        {
            for(var i = 1;  i <= length; i++)
            {
                document.getElementById("additional-info_" + i).querySelector("#select-options_nr-1").style.display = "inline";
                document.getElementById("additional-info_" + i).querySelector("#select-options_nr-2").style.display = "inline";
            }
            /*
            document.getElementById("selects").style.marginLeft = "5%";

            document.getElementById("checks").style.display = "inline";
            document.getElementById("factors").style.display = "inline";
            document.getElementById("additional-info").style.display = "inline";
            
            document.getElementById("tod-checkbox-ui").checked = true;
            document.getElementById("unit-checkbox-ui").checked = true;
            */
        }

        set_cookie("interface_type", 90);
    }

    // #67 changed func
    function simplify_ui_partly()
    {
        var length = get_amount_inputs();
        // As i activate some part of the advanced ui, it is no longer the simplified view, so deactivate it
        document.getElementById("simplify-ui").checked = false;

        // If both are checked, use the simplify_ui function to set everything back to normal, but activate the buttons to make it look 
        if(document.getElementById("tod-checkbox-ui").checked && document.getElementById("unit-checkbox-ui").checked)
        {
            document.getElementById("simplify-ui").checked = false;
            
            for(var i = 1;  i <= length; i++)
            {
                document.getElementById("additional-info_" + i).querySelector("#select-options_nr-1").style.display = "inline";
                document.getElementById("additional-info_" + i).querySelector("#select-options_nr-2").style.display = "inline";
            }
        }
        else if(document.getElementById("tod-checkbox-ui").checked && !document.getElementById("unit-checkbox-ui").checked)
        {
            for(var i = 1;  i <= length; i++)
            {
                document.getElementById("additional-info_" + i).querySelector("#select-options_nr-1").style.display = "none";
                document.getElementById("additional-info_" + i).querySelector("#select-options_nr-2").style.display = "inline";
            }
        }    
        else if(!document.getElementById("tod-checkbox-ui").checked && document.getElementById("unit-checkbox-ui").checked)
        {
            for(var i = 1;  i <= length; i++)
            {
                document.getElementById("additional-info_" + i).querySelector("#select-options_nr-1").style.display = "inline";
                document.getElementById("additional-info_" + i).querySelector("#select-options_nr-2").style.display = "none";
            }
        }
        else 
        {
            document.getElementById("simplify-ui").checked = false;

            for(var i = 1;  i <= length; i++)
            {
                document.getElementById("additional-info_" + i).querySelector("#select-options_nr-1").style.display = "inline";
                document.getElementById("additional-info_" + i).querySelector("#select-options_nr-2").style.display = "inline";
            }
        }

        var date = new Date();
        date.setTime(date.getTime());

        set_cookie("interface_type", 90);
    }
</script>
</html>