<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8"/>
    <title>trainigsplan</title>

    <style>
        .mobile_button button.mobile_button,  button.mobile_button {
           font-size: 35px;
           height: 5vh;
        }

        /*.mobile_p p.mobile_p,  p.mobile_p {
           font-size: 30px;
        }*/

        .mobile_span span.mobile_span,  span.mobile_span {
           font-size: 30px;
        }

        .mobile_label label.mobile_label,  label.mobile_label {
           font-size: 30px;
        }
    </style>

    <link rel="stylesheet" type="text/css" href="css/main.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.1/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@8"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@1/dark.css">


    <script src="http://jakob.ml:8081/auth/js/keycloak.js"></script> 
    <script>
        var keycloak;

        function display_error(type, title, message)
        {
            var footer = '<hr style="height: 2px; background-color:#666;"><br>';

            console.log(message);

            if(message.includes('backend') && message.includes('unavailable') || message.includes('Authentification'))
                footer += message + '<br><br><a href onclick="location.reload()">Reload the Page!</button><br>';

            if(type == 'error')
                footer += '<a href="https://github.com/jkbngl/trainingsplan/issues/new">If you think this is not correct please open a github issue!</a>'
                
            footer += '<br><br><hr style="height: 2px; background-color:#666;"><br>';

            Swal.fire({
              type: type,
              customClass: mobile_swal,
              title: title,
              html: footer
            })
        }

        document.addEventListener('DOMContentLoaded',function(){
            try
            {
                swal.fire({
                    title: 'Loading your data...',
                    customClass: mobile_swal,
                    allowEscapeKey: false,
                    allowOutsideClick: false,
                    onOpen: () => {
                      swal.showLoading();
                    }
                });

                keycloak = Keycloak();

                keycloak.init({ onLoad: 'login-required' })

                keycloak.init().success(
                    function(authenticated) 
                    {
                        // alert(authenticated ? 'authenticated' : 'not authenticated');
                    }
                ).error(function() {
                    // alert('failed to initialize');
                });

                keycloak.onAuthSuccess = function() 
                { 
                    swal.close();
                    console.log('Successfully authenticated');
                
                    username = keycloak.idTokenParsed.preferred_username;
                    username = username.toLowerCase();
                    check_roles(keycloak.realmAccess.roles);
                
                    document.getElementById("username").innerHTML = username + ' <i class="fas fa-sign-out-alt"></i>';

                    build_page();           
                             
                
                    if( isMobile.any() ) 
                        customize_mobile();
                    else
                        ;
                }
            }
            catch(err)
            {
                console.log("error");
                display_error("error", "Ooops...", "Error with Authentification, please try again at a later point");
                window.stop() 
            }
        });

        function getusername()
        {
            return username;
        }
    </script>
</head>
<body>
    <div class="fixed-background blue-gradient-bg"></div>

    <div id="mySidenav" class="sidenav" style="z-index:2;">
        <button id="open-nav-button" onclick="closeNav()"                      class="button" style="float:right; float:top; margin-right: 10%; margin-bottom: 15%" ><i class="fas fa-bars"></i></a>
        <!--<a href="#">About</a>-->
        <!--<button onclick="receivePlanfromDB(false)" class="button" style=" top: 10px; width:80%; margin-left: 10%;">Load Plan</button>
        <button onclick="cleanUpTables(); addTable(true);  closeNav();"class="button" style="top: 10px; width:80%; margin-left: 10%;">New Plan</button>-->
        <button onclick="window.location.href='index.html'" class="button" style="top: 10px; width:80%; margin-left: 10%;"><i class="fas fa-home"></i> Home</button>
        <!--<button onclick="save_settings(); update_chart();"                  class="button" style="top: 10px; width:80%; margin-left: 10%; margin-top: 20%;"><i class="far fa-save"></i> Save Preferences</button>-->
        <button onclick="window.location.href='stats.html'" class="button" id="stats-button" style="top: 10px; width:80%; margin-left: 10%;"><i class="fas fa-chart-line"></i> Stats</button>
        
        <button onclick="download();" class="button" style="top: 10px; width:80%; margin-left: 10%; margin-top: 20%;"><i class="fas fa-trash-restore-alt"></i> Restore</button>
        <button onclick="download();" class="button" style="top: 10px; width:80%; margin-left: 10%;"><i class="fas fa-file-export"></i> Export</button>

        <div class="page__toggle" style="margin-left: 10%; margin-top: 12%;">
            <label class="toggle">
            <input id="simplify-ui" onchange="closeNav();" onclick="simplify_ui(); save_settings();" class="toggle__input" type="checkbox">
            <span class="toggle__label">
                <span class="toggle__text">Simple interface 
                    <i class="fas fa-info-circle" rel="tooltip" title="If simple Interface is turned on, the website will use the default values (check what the default settings are by clicking reset settings above, Attention: old settings will be lost) and in addition make the interface simpler by not showing the advanced settings" id="info-step-2"></i>
                </span>
            </span>
            </label>
        </div>

        <div class="page__toggle" style="margin-left: 20%; margin-top: 7%;">
            <label class="toggle">
            <input id="factors-checkbox-ui" onclick="simplify_ui_partly(); save_settings();" class="toggle__input" type="checkbox">
            <span class="toggle__label">
                <span class="toggle__text">Show Unit 
                    <i class="fas fa-info-circle" rel="tooltip" title="If this checkbox is active you can access the part of the advanced ui where you can change the factors per attribute" id="info-step-2"></i>
                </span>
            </span>
            </label>
        </div>

        <div class="page__toggle" style="margin-left: 20%; margin-top: 5%;">
            <label class="toggle">
            <input id="checks-checkbox-ui" onclick="simplify_ui_partly(); save_settings();" class="toggle__input" type="checkbox">
            <span class="toggle__label">
                <span class="toggle__text">Show Time of Day
                    <i class="fas fa-info-circle" rel="tooltip" title="If this checkbox is active you can access the part of the advanced ui where you can change the attributes that should be used to calc the data in the chart" id="info-step-2"></i>
                </span>
            </span>
            </label>
        </div>

        <div class="page__toggle" style="margin-left: 10%; margin-top: 25%;">
            <label class="toggle">
            <input id="chart-type" onchange="closeNav();" onclick="clear_chart(); update_bm_chart(get_active_bms());" class="toggle__input" type="checkbox">
            <span class="toggle__label">
                <span class="toggle__text">Bar Chart 
                    <i class="fas fa-info-circle" rel="tooltip" title="Change between the normal line chart and the bar chart to analyze your data" id="info-step-2"></i>
                </span>
            </span>
            </label>
        </div>

        <button onclick="keycloak.logout('/trainingsplanorwhateveritdoesntworkanyway'); kc.logout()"class="button" style="top: 10px; width:80%; margin-left: 10%; margin-top: 20%"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>

    <div id = "headerforbuttons" style="display: flex; justify-content: space-between; position:fixed; width:100%; z-index:1;">
        <button onclick="openNav()" class="button" style="top: 10px;"><i class="fas fa-bars"></i></span>
            <button onclick="window.location.href='index.html'" class="button" style="top: 10px;" ><i class="fas fa-home"></i> Home</button>
            <button onclick="save()" class="button" style="top: 10px;" ><i class="far fa-save"></i> Save</button>
            <button onclick="keycloak.logout()" class="button" value="username ..." id="username" style="top: 10px;"></button>
    </div>â€‹

    <div id="div-line-chart" style="position: relative; margin-top: 2.5%; height: 60vh; z-index: 0">
        <canvas id="line-chart" height="100"></canvas>
    </div>
    <button id="clear-potential" onclick="closeNav(); clear_potential(true)" class="button" style="display: inline-block; position: absolute; right: 0; margin-bottom: 4%; margin-right: 1%" >Clear Potential <!--<i style="display: inline-block;" class="fas fa-trash"></i>--></button>
    <button id="add-new-input" onclick="closeNav(); add_html_input(true)" class="button" style="width:20%; margin:auto;  display: table;margin: 0 auto; margin-bottom: 4%" >Add <i class="fas fa-plus-circle"></i></a> </button>


    <div id="container_bm">
       <!-- Here come all the dinamically created bms-->
    </div>
</body>

<script>
    // Object to store data for all actively displayed data in chart
    var active_bm = [

    ];

    // global variable to handle the creation and destruction of chart easily
    var chart;
    
    // global variable to handle the creation and destruction of different chart easily, line = default
    // var chart_type = 'line';

    // Here the class is set for the swal to use, depending on mobile or desktop, desktop leave empty - mobile is set in customize_mobile
    var mobile_swal = '';             

    // #67 Newly added func
    function get_amount_inputs()
    {
        // Get the main_div with all the stats inside
        var main_div = document.getElementById('container_bm');

        // Divided by 4 because there are additionally 4 divs in the main divs
        var amount_stats = main_div.getElementsByTagName('div').length;

        return amount_stats / 4;
    }

    // #67 Newly added func
    function save()
    {
        var amount_stats = get_amount_inputs();
        var jsonData = {
            stats: []
        };
        var allowed_to_save = false;
        var values_are_numeric = false;

        for(let i = 1; i <= amount_stats; i++)
        {
            jsonData.stats.push({ 
                "username" : getusername(),
                "name"     : document.getElementById("additional-info_" + i).querySelector("#value_name").value,
                "value"    : document.getElementById("additional-info_" + i).querySelector("#value_value").value,
                "note"     : document.getElementById("additional-info_" + i).querySelector("#note").value,
                "id"       : document.getElementById("additional-info_" + i).getAttribute('value'),
                "uom"      : document.getElementById("additional-info_" + i).querySelector("#select_1").options[document.getElementById("additional-info_" + i).querySelector("#select_1").selectedIndex].value,
                "tod"      : document.getElementById("additional-info_" + i).querySelector("#select_2").options[document.getElementById("additional-info_" + i).querySelector("#select_2").selectedIndex].value
            });
        }


        for(let i = 0; i < amount_stats; i++)
        {
            if(jsonData.stats[i].tod.length > 0 && jsonData.stats[i].uom.length > 0 && jsonData.stats[i].name.length > 0)
            {
                allowed_to_save = true;
            }
            else
            {
                allowed_to_save = false;
               
            }
            
            if(isNaN(jsonData.stats[i].value))
            {
                values_are_numeric = false;
            }
            else
            {
                values_are_numeric = true;
            }

            if(!values_are_numeric || !allowed_to_save)
                break;
        }
        

        if(allowed_to_save && values_are_numeric)
        {
            send_bm_data_to_backend(jsonData)
        }
        else
        {
            if(!allowed_to_save && !values_are_numeric)
                display_error('error', 'Name, UNIT and time of day have to be selected and values must be numeric and may not contain letters', 'dont know');
            else if(!allowed_to_save && values_are_numeric)
                display_error('error', 'Name, UNIT and time of day have to be selected', 'dont know');
            else if(!values_are_numeric && allowed_to_save)
                display_error('error', 'Values must be numeric and may not contain letters!', 'dont know');
        }
    }

    // #67 Newly added func
    function send_bm_data_to_backend(jsonData)
    {
        try
        {
            var xhr = new XMLHttpRequest();
            var url = "http://jakob.ml:8080/tpbackend_1-1.0-SNAPSHOT/api/trainingsplan/send_bm_values";
            xhr.open("POST", url, true);
            xhr.setRequestHeader("Content-Type", "text/plain");
            var string = JSON.stringify(jsonData);
            
            xhr.send(string);

            checkIfDataIsLoadedIntoDB(xhr);
        }
        catch(err)
        {
            console.error(err);
            display_error('error', 'Oops...', 'The backend seems to be unavailable!')
        }
    }

    // #67 Newly added func
    function checkIfDataIsLoadedIntoDB(xhr)
    {
        swal.fire({
          title: 'Saving your Data...',
          allowEscapeKey: false,
          customClass: mobile_swal,
          allowOutsideClick: false,
          onOpen: () => {
            swal.showLoading();
          }
        });

        var counter = 0;
        var check = function(){
            if(xhr.status == 200){
                console.log("POST worked, data send, reload page with new data: " + xhr.status);
                
                
                console.log("RESPONSE: " + xhr.responseText);

                if(xhr.responseText == "ok")
                {
                    swal.fire({
                        title: 'Your bms were saved!',
                        type: 'success',
                        //position: 'top-end',
                        timer: 1000,
                        customClass: mobile_swal,
                        showCancelButton: false,
                        showConfirmButton: false
                    });
                }
                else if(xhr.responseText.includes("Same bm does already exist"))
                {
                    console.log("CATCHED")
                    display_error("error", xhr.responseText, "You entered a bm which is already existent in its unique combination");
                }
                
                
                on_save();
            }
            else if(xhr.status != 200 && xhr.status != 0)
            {
                swal.fire({
                    title: 'ERROR - ' + xhr.status + "!",
                    type: 'error',
                    //position: 'top-end',
                    customClass: mobile_swal,
                    timer: 5000,
                    showCancelButton: false,
                    showConfirmButton: false
                });
            }
            else if(counter >= 200) // After 20 (if check wait time is still 100) seconds of waiting, stop
            {
                display_error("error", "Ooops...", "The backend seems to be unavailable");
            }
            else {
                if(counter == 50)
                {
                    swal.fire({
                      title: 'This takes longer than usual, please be patient',
                      customClass: mobile_swal,
                      allowEscapeKey: false,
                      allowOutsideClick: false,
                      onOpen: () => {
                        swal.showLoading();
                      }
                    });
                }

                console.log("waiting");
                counter++;
                setTimeout(check, 100); // check again in a second
            }
        }
        
        // If not waiting longe than 10 seconds
        if(counter < 100)
            check();
    }

    // #67 Newly added func
    function on_save()
    {
        var num_input = get_amount_inputs();

        document.getElementById("container_bm").innerHTML = '';
        
        clear_chart();  
        build_page();
    }

    // #67 newly added func
    function set_bm_as_deactivated_as_callback_from_chart(event, bm_name)
    {
        var meta_data_id = chart.getDatasetMeta(bm_name.datasetIndex).controller.chart.id;

        // At first its undefined so set it as defined at the beginnning
        if(chart.data.datasets[bm_name.datasetIndex]['_meta'][meta_data_id].hidden === false)
            chart.data.datasets[bm_name.datasetIndex]['_meta'][meta_data_id].hidden = false;   // At first it is always active, so set it to hidden true, which is active
        else
            ;

        if(chart.data.datasets[bm_name.datasetIndex]['_meta'][meta_data_id].hidden)
        {
            chart.data.datasets[bm_name.datasetIndex]['_meta'][meta_data_id].hidden = false;
            document.getElementById("additional-info_" + (bm_name.datasetIndex + 1)).querySelector("#reps_box").checked = true;
        }
        else if(!chart.data.datasets[bm_name.datasetIndex]['_meta'][meta_data_id].hidden)
        {
            // If the chart goes from the active state into hidden state
            console.log("CALLED HERE as callback from chart legend");
            clear_potential(false, bm_name.datasetIndex);
            chart.data.datasets[bm_name.datasetIndex]['_meta'][meta_data_id].hidden = true;
            document.getElementById("additional-info_" + (bm_name.datasetIndex + 1)).querySelector("#reps_box").checked = false;
        }

        chart.update();

        set_cookie('active', 90);
    }

    function download() 
    {
        var amount_bms = get_amount_inputs();
                
        if(amount_bms > 0)
        {
            // Get the data to save the file with different names #
            // TODO read active_ex_in_chart and add ex names
            
            var url_base64 = document.getElementById('line-chart').toDataURL('image/png');
            var element = document.createElement('a');
            
            element.setAttribute('href', url_base64);
            element.setAttribute('download', 'chart_' + get_date() + '.png');
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }
        else
        {
            alert("Nothing to export!");
        }
    }

    function get_date()
    {
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
        var yyyy = today.getFullYear();

        return mm + '_' + dd + '_' + yyyy;
    }

    // #67 Newly added func
    function append_combo(div)
    {
        var json_uoms = rest_uoms();
        var json_tods = rest_tods();

        var s_1 = document.getElementById(div).querySelector("#select_1");
        var s_2 = document.getElementById(div).querySelector("#select_2");

        
        for(var i = 0; i < json_uoms.length; i++) 
        {
            var opt = document.createElement('option');
            opt.value = json_uoms[i];
            opt.innerHTML = json_uoms[i];
            opt.id = 'option_element';
            s_1.appendChild(opt);
        }

        for(var i = 0; i < json_tods.length; i++) 
        {            
            var opt = document.createElement('option');
            opt.value = json_tods[i];
            opt.innerHTML = json_tods[i];
            opt.id = 'option_element';
            s_2.appendChild(opt);
        }
    }
    
    // #67 Newly added func
    function rest_uoms()
    {
        try
        {
            var request = new XMLHttpRequest();
            var url = 'http://jakob.ml:8080/tpbackend_1-1.0-SNAPSHOT/api/trainingsplan/get_uoms/';
            var xmlHttp = new XMLHttpRequest();

            xmlHttp.open( "GET", url, false ); // false for synchronous request
            xmlHttp.send( null );
            uoms = xmlHttp.responseText;

            return JSON.parse(uoms);
        }
        catch(err)
        {
            console.error(err);
            display_error('error', 'Oops...', 'The backend seems to be unavailable!')
        }
    }

    // #67 Newly added func
    function rest_tods()
    {
        try
        {
            var url = 'http://jakob.ml:8080/tpbackend_1-1.0-SNAPSHOT/api/trainingsplan/get_tods/';
            var xmlHttp = new XMLHttpRequest();

            xmlHttp.open( "GET", url, false ); // false for synchronous request
            xmlHttp.send( null );
            tods = xmlHttp.responseText;
            
            return JSON.parse(tods);
        }
        catch(err)
        {
            console.error(err);
            display_error('error', 'Oops...', 'The backend seems to be unavailable!')
        }
    }

    // #67 Newly added func
    function add_html_input(via_button, id, active_or_not, name, value, select_uom, select_tod, note, base_bm)
    {
        //Give the new div a number which is the current amount + 1
        var num_input = get_amount_inputs() + 1;
        // Create a container that will be added to the div
        var container = document.createElement("div");
        container.setAttribute("id", "div_to_delete");
        
        if(via_button)
            id = "defaultvaluetoignore";

        container.innerHTML = '<div id="additional-info_' + num_input + '" value="' + id + '" base_bm="' + base_bm + '" style="width: 100%; margin-bottom: 3%; display: flex; flex-direction: row; flex-wrap: nowrap;justify-content: space-between;"> \
            <div id="check-2" class="page__toggle"  style="margin-top: 10px; margin: auto;  margin-left:1%; z-index:1;"> \
                <label class="toggle"> \
                    <input id="reps_box" onchange="closeNav();" onclick="set_cookie(\'active\', 90); toggle_chart_datasets(); show_potential()"  class="toggle__input" type="checkbox" checked> \
                    <span class="toggle__label"> \
                        <span class="toggle__text">Active</span> \
                    </span> \
                </label> \
            </div> \
            \
            <input type="text" ' + ( via_button                   ? 'autofocus' : '') + ' id="value_name"  class="input_bm" placeholder="&nbsp; Enter the name of input value ..." style="text-align:center; background: transparent; border-radius: 25px; border: 2px solid #00ad5f; color:#00ad5f; width: 25%; font-size: 18px;font-family: Century Gothic; margin-right:2%; margin-left:2%; "> \
            <input type="number" ' + (!via_button && num_input <= 1 ? 'autofocus' : '') + ' onchange="show_potential()" id="value_value" class="input_bm" placeholder="&nbsp; Value of input ..."      style="text-align:center; background: transparent; border-radius: 25px; border: 2px solid #00ad5f; color:#00ad5f; width: 15%; font-size: 18px;font-family: Century Gothic; margin-right:2%"> \
            <input type="text" id="note" class="input_bm" placeholder="&nbsp; Note ..." style="text-align:center; background: transparent; border-radius: 25px; border: 2px solid #00ad5f; color:#00ad5f; width: 25%; font-size: 18px;font-family: Century Gothic; margin-right:2%; "> \
            \
            <div class="select" style="border-bottom: 4px solid rgba(0,0,0, 0.12); border-right: 4px solid rgba(0,0,0, 0.12); margin-right: 5%"> \
                <select id= "select_1" onchange="closeNav();" class="select-text" required > \
                    <option value="" selected></option> \
                </select> \
                <span class="select-highlight"></span> \
                <label id="select-text" style="font-size: 22px;" class="select-label">UNIT \
                <i class="fas fa-info-circle" rel="tooltip" title="Select an exercise from this list to have the history (if existent) of your data displayed in the chart above  " id="info-step-1"></i> \
                    </label> \
                <span class="select-bar"></span> \
            </div> \
             \
            <div class="select" style="border-bottom: 4px solid rgba(0,0,0, 0.12); border-right: 4px solid rgba(0,0,0, 0.12); margin-right: 5%"> \
                <select id= "select_2" onchange="closeNav();" class="select-text" required > \
                    <option value="" selected></option> \
                </select> \
                <span class="select-highlight"></span> \
                <label id="select-text" style="font-size: 22px;" class="select-label">Time of Day \
                <i class="fas fa-info-circle" rel="tooltip" title="Select an exercise from this list to have the history (if existent) of your data displayed in the chart above  " id="info-step-1"></i> \
                </label> \
                <span class="select-bar"></span> \
            </div> \
            <button class="button" id="visualize_progress_button" onclick="show_progress_dialog(' + num_input + ')" style="margin-right: 1%"><i class="fas fa-info-circle"></i></button> \
            <button class="button" id="delete_button" onclick="delete_and_reoder(' + num_input + ')" style="margin-right: 1%"><i class="fas fa-trash"></i></button> \
        </div>';

        document.getElementById("container_bm").appendChild(container);

        const node = document.getElementById("div_to_delete");
        node.replaceWith(...node.childNodes);

        append_combo("additional-info_" + num_input);

        if(!via_button)
        {
            document.getElementById("additional-info_" + num_input).querySelector("#value_name").value = name;
            document.getElementById("additional-info_" + num_input).querySelector("#value_name").disabled = true;
            document.getElementById("additional-info_" + num_input).querySelector("#value_name").style.color = "gray";

            document.getElementById("additional-info_" + num_input).querySelector("#value_value").value = value;
            document.getElementById("additional-info_" + num_input).querySelector("#note").value = note;

            document.getElementById("additional-info_" + num_input).querySelector("#select_1").value = select_uom;
            //document.getElementById("additional-info_" + num_input).querySelector("#select_1").disabled = true;

            document.getElementById("additional-info_" + num_input).querySelector("#select_2").value = select_tod;
            //document.getElementById("additional-info_" + num_input).querySelector("#select_2").disabled = true;
        }
    }

    // #67 newly added func
    function show_potential()
    {
        // get the send bms
        var active_bms = get_active_bms();
        // Amount of elements in the currentyl active bms
        var num_last_elem;
        // All historic values of the bm
        var current_active_values = [];
        
        for(var i = 0; i < active_bms.length; i++)
        {
            // get the last value of the bm, the current one
            var bm = JSON.parse(active_bms[i])
            num_last_elem = bm.length - 1;


            if(bm[num_last_elem].value != document.getElementById("additional-info_" + (i + 1)).querySelector("#value_value").value && document.getElementById("additional-info_" + (i + 1)).querySelector("#reps_box").checked)
            {
                for(var j = 0; j < num_last_elem + 1; j++)
                {
                    current_active_values.push(bm[j].value);
                }

                current_active_values.push(document.getElementById("additional-info_" + (i + 1)).querySelector("#value_value").value);

                chart.data.datasets.push({
                    data: current_active_values,
                    label: 'potential_value_number_' + i,
                    borderColor: border_color_array[i],
                    backgroundColor: border_color_array[i],
                    borderDash: [10],
                    fill: false
                });

                // Set the animation duration to 0 to not show that a new dataset has been added to chart 
                var old_animation_duration = chart.options.animation.duration;
                chart.options.animation.duration = 0;
                chart.update();
                // Set it back to the old value
                chart.options.duration = old_animation_duration;
                
                // Clean at the end
                current_active_values = [];
            }
        }    
    }

    // #67  newly added func
    function set_cookie(cname, exdays) 
    {    
        var amount_days = get_amount_inputs();
        var d = new Date();
        d.setTime(d.getTime() + (exdays*24*60*60*1000));
        var expires = "expires=" + d.toGMTString();
        
        // Dont comment in, only in case all coockies should be deleted, for testing purpose - should never be commented in in production
        //delete_all_cookies();

        for(var i = 0; i < amount_days; i++)
        {
            document.cookie = cname + "_"+ i + "=" + document.getElementById("additional-info_" + (i + 1)).querySelector("#reps_box").checked + ";" + expires + ";path=/";
        }    
    }

    // #67  newly added func
    function delete_all_cookies() 
    {
        document.cookie.split(";").forEach(function(c) { document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); });
    }

    // #67 changed func
    function get_cookie(cname, index) 
    {
        var name = cname + index + "=";
        var decodedCookie = decodeURIComponent(document.cookie);
        var ca = decodedCookie.split(';');
        
        for(var i = 0; i < ca.length; i++) 
        {
            var c = ca[i];

            while (c.charAt(0) == ' ') 
            {
                c = c.substring(1);
            }

            if (c.indexOf(name) == 0) 
            {
                set_dataset_and_button(index, c.substring(name.length, c.length));
                //return c.substring(name.length, c.length);
            }
        }

        console.log("NO COOKIES FOUND");
        //return "";
    }

    // #67  newly added func
    function set_dataset_and_button(index, bool)
    {
        var meta_data_id = chart.getDatasetMeta(index).controller.chart.id;

        // String does not work so I need to parse it to a javascript object
        var myBool = JSON.parse(bool);

        
        document.getElementById("additional-info_" + (index + 1)).querySelector("#reps_box").checked = myBool;
        chart.data.datasets[index]['_meta'][meta_data_id].hidden = !myBool;    // Hidden so turn it around

        // In order that it is displayed correctly in the chart I need to update the chart so that it is also visible not only in the background
        chart.update();
    }

    // #67  newly added func
    function toggle_chart_datasets()
    {
        var length = get_amount_inputs();

        for(var i = 0; i < length; i++)
        {
            var meta_data_id = chart.getDatasetMeta(i).controller.chart.id;

            if(!document.getElementById("additional-info_" + (i + 1)).querySelector("#reps_box").checked)
            {
                chart.data.datasets[i]['_meta'][meta_data_id].hidden = true;

                // clear the potential of the bm as well and not only the active - the ones which are not active
                clear_potential(false, i);
            }
            else
            {
                chart.data.datasets[i]['_meta'][meta_data_id].hidden = false;
            }    
            
            chart.update();
        }
    }

    // 67 newly added function
    function delete_and_reoder(num_to_delete)
    {
        var current_active_amount = get_amount_inputs();
        document.getElementById("additional-info_" + num_to_delete).remove();

        // If the last one was deleted nothing needs to be changed
        if(num_to_delete == current_active_amount)
        {
            console.log("nothing to reorder")
        }    
        else
        {
            for(var i = num_to_delete; i <= current_active_amount; i++)
            {
                console.log("current_active_amount: " + current_active_amount + " | num_to_delete: " + num_to_delete + " | i: " + i)
                
                // 1 can not be set to 0
                if(i > 1)
                {
                    if(document.body.contains(document.getElementById("additional-info_" + i)))
                    {
                        document.getElementById("additional-info_" + i).id = "additional-info_" + (i - 1);
                        document.getElementById("additional-info_" + (i - 1)).querySelector("#delete_button").setAttribute( "onClick","delete_and_reoder(" + (i - 1) + ");");
                    } 
                }       
            }
        }
        
        // if all were deleted add one so that anytime at least one is active
        if(get_amount_inputs() == 0)
        {
            add_html_input(true);
        }
    
    }

    // #67 Newly added func
    function build_page()
    {
        // empty String bms which will in case there are any contain the json object with the bms in it
        var bms = '';

        bms = rest_get_bms();

        if(bms.length > 0)
        {
            // Load his bms from the backend into the frontend
            for(var i = 0; i < bms.length; i ++)
            {
                add_html_input(false, bms[i].id, true, bms[i].value_name, bms[i].value, bms[i].uom, bms[i].tod, bms[i].note, bms[i].base_bm_value)
            }
        }
        else
        {
            // Add one single new when the user has none yet
            add_html_input(true);
        }

        active_bm = [];

        active_bm = get_active_bms();

        update_bm_chart(active_bm);

        // TODO load from cookies if active or not
        var length = get_amount_inputs();
        for(var i = 0; i < length; i++)
            get_cookie("active_", i);


        // If the user has currently no bms present load one single input field and add the uoms and tods from the backend
        // append_combo("additional-info_1");
    }

    

    // #67 newly added func
    function get_active_bms()
    {
        var amount_bms = get_amount_inputs();
        active_bm = [];

        for(var i = 1; i <= amount_bms; i++)
        {
            active_bm.push(rest_get_historical_bm(document.getElementById("additional-info_" + i).getAttribute("base_bm")));
        }

        return active_bm;
    }

    // #67 Newly added func
    function rest_get_bms()
    {
        try
        {
            var url = 'http://jakob.ml:8080/tpbackend_1-1.0-SNAPSHOT/api/trainingsplan/get_bm_values/';
            var xmlHttp = new XMLHttpRequest();
        
            xmlHttp.open( "GET", url + getusername() + "/0", false ); // false for synchronous request
            xmlHttp.send( null );
            bms = xmlHttp.responseText;
        
            return JSON.parse(bms);
        }
        catch(err)
        {
            console.error(err);
            display_error('error', 'Oops...', 'The backend seems to be unavailable!')
        }
    }

    // #67 newly added func
    function show_progress_dialog(num_bm)
    {
        // Get the base_bm_id of the clicked bm
        var bm_id = document.getElementById("additional-info_" + num_bm).getAttribute("base_bm");
        var json_history_bm = JSON.parse(rest_get_historical_bm(bm_id));
        var bm_name = document.getElementById("additional-info_" + num_bm).querySelector("#value_name").value


        Swal.fire({html:  parse_base_bm(json_history_bm, bm_name), customClass: mobile_swal});
    }

    // #67 newly added func
    function parse_base_bm(json_bm, bm_name)
    {
        //  to_dispay += '<font color="green">Reps: ' + json.values[i].reps + "</font><br>";
        var to_dispay = "<h2>" + bm_name.toUpperCase() + " [" + json_bm[0].uom + "]" + " - " + json_bm[0].tod + "</h2><br><br>";

        for(var i = 0; i < json_bm.length; i++)
        {
            console.log(json_bm[i].note.length)
            var date = new Date(json_bm[i].created).toUTCString()
            to_dispay += (i + 1) + ". Entry on: " + date.split(' ').slice(1, 4).join(' ') + "<br>";

            if(i > 0)
                if(json_bm[i].value > json_bm[i - 1].value)
                {
                    to_dispay += '<font color="green">Value: ' + json_bm[i].value + (json_bm[i].note.length != 0 ? "<br>Note:" + json_bm[i].note : "") + "</font><br>";
                }    
                else if(json_bm[i].value < json_bm[i - 1].value)
                {
                    to_dispay += '<font color="red">' + json_bm[i].value + (json_bm[i].note.length != 0 ? "<br>Note:" + json_bm[i].note : "") + "</font><br>"; 
                }
                else
                {
                    to_dispay += '<font color="white">' + json_bm[i].value + (json_bm[i].note.length != 0 ? "<br>Note:" + json_bm[i].note : "") + "</font><br>"; 
                }
            else
                to_dispay += '<font color="white">' + json_bm[i].value + (json_bm[i].note.length != 0 ? "<br>Note:" + json_bm[i].note : "") + "</font><br>"; 
        } 
        
        return to_dispay;
    }

    // #67 newly added func
    function clear_potential(full, bm_id)
    {
        if(full)
        {
            // Remove all datasets with the configured chart name
            chart.data.datasets = chart.data.datasets.filter(function(obj) {
                return (!obj.label.includes('potential_value_number_')); 
            });
        }
        else
        {
            //console.log("going to clear: " + bm_id)
            // Remove only the datasets defined in the function call
            chart.data.datasets = chart.data.datasets.filter(function(obj) {
                return (obj.label != 'potential_value_number_' + bm_id); 
            });
        }

        chart.update();   
    }

    // #67 Newly added func
    function rest_get_historical_bm(bm_id)
    {
        try
        {
            var url = 'http://jakob.ml:8080/tpbackend_1-1.0-SNAPSHOT/api/trainingsplan/get_historical_bm_values/';
            var xmlHttp = new XMLHttpRequest();

            xmlHttp.open( "GET", url + getusername() + "/" + bm_id, false ); // false for synchronous request
            xmlHttp.send( null );
            history_bms = xmlHttp.responseText;

            return history_bms;
        }
        catch(err)
        {
            console.error(err);
            display_error('error', 'Oops...', 'The backend seems to be unavailable!')
        }
    }

    // #67 changed function
    function clear_chart()
    {
        chart.reset();
        chart.clear();
        chart.destroy();

        
        if(document.getElementById("chart-type").checked)
            chart = create_chart("bar");
        else
            chart = create_chart('line');

        //change_div(0, 0, true);
        //active_ex_in_chart = [];
        //num_ex = 0;
        // console.log(num_ex);
        return chart;
    }

    // #67 Newly added func
    function update_bm_chart(bms)
    {
        if(document.getElementById("chart-type").checked)
            chart = create_chart("bar");
        else
            chart = create_chart("line");

        var values = [];
        var bm_name = '';
        // If one ex active show dates of active
        var local_labels_date = [];
        // if multiple ex active show amount of datapoints
        var local_labels_numbers = [];

        for(var i = 0; i < bms.length; i++)
        {
            parsed_bm = JSON.parse(bms[i]);

            for(var j = 0; j < parsed_bm.length; j++)
            {
                values[j] = parsed_bm[j].value;                

                dateString = new Date(parsed_bm[j].created).toUTCString();
                local_labels_date.push(dateString.split(' ').slice(1, 4).join(' '));

                // console.log(parsed_bm[j].uom);
                // console.log(parsed_bm[j].tod);

                // Once
                if(j == 0)
                {
                    bm_name = parsed_bm[j].value_name;
                    bm_uom = parsed_bm[j].uom;
                    bm_tod = parsed_bm[j].tod;

                    bm_legend_name = bm_name + " [" + bm_uom + "]" + " - " + bm_tod;
                    
                    local_labels_numbers.push(parsed_bm.length);
                }
            }

            local_labels_date.push("potential");
            
            if(document.getElementById("additional-info_" + (i + 1)).querySelector("#reps_box").checked)
            {
                chart.data.datasets.push({
                    data: values,
                    label: bm_legend_name,
                    borderColor: border_color_array[i],
                    backgroundColor: border_color_array[i],
                    fill: false
                });

                if(bms.length == 1)
                {
                    chart.data.labels = local_labels_date;
                }
                else
                {    
                    var max_num = Math.max.apply(Math, local_labels_numbers);
                    local_labels_numbers = [];
                    
                    // Start at 0 to have 1 extra space for potential
                    for(var k = 0; k <= max_num; k++)
                        local_labels_numbers.push(k);
                        

                    chart.data.labels = local_labels_numbers;
                }

                chart.update();
            }        

            // Clear for next bm
            values = [];
            bm_name = '';
        }
    }

    function reset_settings()
    {
        document.getElementById("weight-slider").value = 1;
        document.getElementById("reps-slider").value = 1;
        document.getElementById("sets-slider").value = 1;
        document.getElementById("maxrep-slider").value = 1;

        document.getElementById("weight-slider-button").innerHTML = "Weight Faktor: " + 1 + " &nbsp&nbsp&nbsp";
        document.getElementById("reps-slider-button").innerHTML = "Reps Faktor: " + 1 + " &nbsp";
        document.getElementById("sets-slider-button").innerHTML = "Sets Faktor: " + 1 + " &nbsp";
        document.getElementById("maxrep-slider-button").innerHTML = "MaxRep Faktor: " + 1 + " &nbsp";

        document.getElementById("weight_box").checked = true;
        document.getElementById("reps_box").checked = true;
        document.getElementById("sets_box").checked = true;
        document.getElementById("max_rep_box").checked = false;
    }

    // #67 changed func
    function check_roles(assigned_roles)
    {
        var roles = [];
        var pos = 0;

        for(var i = 0; i < assigned_roles.length; i++)
        {
            if(assigned_roles[i] != 'admin' && assigned_roles[i] != 'offline_access' && assigned_roles[i] != 'uma_authorization' && assigned_roles[i] != 'user')
            {
                roles[pos] = assigned_roles[i];
                pos++;
            }
        }

        var superaccount = (roles.indexOf("friend_account") > -1) || (roles.indexOf("paid_account") > -1);

        console.log(roles);

        if(!superaccount)
        {
            if(roles.includes("bm_it_access") != true)
            {
                alert("Access denied!");
                window.location.href='index.html';
            }
            else if(roles.includes("stats_access") != true)
            {
                document.getElementById("stats-button").style.display = "none";
            }
            else
            {
                ;
            }
        }
    }
    

    function does_json_contain_data(object) 
    {
        for(var i in object)
        {
            return true;
        }
        
        return false; 
    } 

   

    var labels = [1,2,3,4,5,6,7,8];
    var border_color_array = [ "#18AD5F" // green
                             , "#BD000A" // burning red
                             , "#102542" // dark blue
                             //, "#F7B32B" // yellow
                             //, "#0EB1D2" // very light blue
                             , "#4b081a" // bordeaux red
                             , "#0D1321" // dark blue
                             , "#f63f01" // orange
                             //, "#F9F7F3" // white 
                             ];

    function create_chart(chart_type)
    {
        // console.log(chart_type)
        if(typeof chart_type == 'undefined')
            chart_type = 'line';

        var chart = new Chart(document.getElementById("line-chart"), {
            type: chart_type,
            data: {
                labels: labels,
                datasets: [
                    
                ]
            },
            options: {
                
                line:{ fill: true},
                hidden: false,
                ticks: {
                    beginAtZero: false,
                    min: 0,
                    max: 5.03,
                    stepSize: 1,
                    padding: 10,
                    fontFamily: 'Karla, sans-serif',
                    maxRotation: 0/*,
                    callback: function(value, index, values) {
                        if (value !== 5.03) {
                            return values[index]
                        }
                    }*/
                },
                title: {
                    display: false,
                    text: 'Trainingsplan'
                },
                legend: {
                    display: true,
                    onClick: (event, legendItem, third) => set_bm_as_deactivated_as_callback_from_chart(event, legendItem),
                    labels: {
                        fontSize: 20,
                        filter: function(item, chart) {
                            // Logic to remove a particular legend item goes here
                            return !item.text.includes('potential_value_number_');
                        }   
                    }
                },
                tooltips: {
                    filter: function (tooltip_item, all_items) 
                    {
                        return !all_items.datasets[tooltip_item.datasetIndex].label.includes("potential_value_number_");
                    }
                },
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });

        return chart;
    }

    function openNav()
    {
        if( isMobile.any() ) 
        {
            document.getElementById("mySidenav").style.width = "300px";
        }
        else
        {
            document.getElementById("mySidenav").style.width = "250px";
        }   
    }

    function closeNav()
    {
        document.getElementById("mySidenav").style.width = "0";
    }

    function save_settings()
    {
        var preferences = {}; 

        preferences.username = getusername(); 
        preferences.check_weight = document.getElementById("weight_box").checked;
        preferences.check_reps = document.getElementById("reps_box").checked;
        preferences.check_sets = document.getElementById("sets_box").checked;
        preferences.check_maxrep = document.getElementById("max_rep_box").checked;
        preferences.check_simple_view = document.getElementById('simplify-ui').checked;
        preferences.check_chart_type  = document.getElementById('chart-type').checked;        
        preferences.check_dialog_save = "ignore";     

        preferences.mul_weight = document.getElementById('weight-slider').value;
        preferences.mul_reps = document.getElementById('reps-slider').value;
        preferences.mul_sets = document.getElementById('sets-slider').value;
        preferences.mul_maxrep = document.getElementById('maxrep-slider').value;

        
        var xhr = new XMLHttpRequest();
        var url = "http://jakob.ml:8080/tpbackend_1-1.0-SNAPSHOT/api/trainingsplan/send_preferences";
        xhr.open("POST", url, true);
        xhr.setRequestHeader("Content-Type", "text/plain");
        var string = JSON.stringify(preferences);

        xhr.send(string);
        //alert("Preferences saved!");
    }

    var isMobile = {
        Android: function() {
            return navigator.userAgent.match(/Android/i);
        },
        BlackBerry: function() {
            return navigator.userAgent.match(/BlackBerry/i);
        },
        iOS: function() {
            return navigator.userAgent.match(/iPhone|iPad|iPod/i);
        },
        Opera: function() {
            return navigator.userAgent.match(/Opera Mini/i);
        },
        Windows: function() {
            return navigator.userAgent.match(/IEMobile/i) || navigator.userAgent.match(/WPDesktop/i);
        },
        any: function() {
            return (isMobile.Android() || isMobile.BlackBerry() || isMobile.iOS() || isMobile.Opera() || isMobile.Windows());
        }
    };

    function customize_mobile(after_startup)
    {
        mobile_swal = 'mobile_swal';

        document.getElementById("headerforbuttons").style.height = "100px";
        chart.options.legend.labels.fontSize = 30;

        document.getElementById("div-line-chart").style.marginTop = "5%";



        if(after_startup)
        {
            console.log("customized");
            //document.getElementById("progress-text").style.fontSize = "30px";
            
            /*
            if(document.getElementById("info-progress"))
                document.getElementById("info-progress").remove();
                */
        }


        var buttons = document.getElementsByTagName("button");
        for(var i = 0, il = buttons.length; i < il; i++)
        {
            buttons[i].className += " mobile_button";
        }

        var spans = document.getElementsByTagName("span");
        for(var i = 0, il = spans.length; i < il; i++)
        {
            spans[i].className += " mobile_span";
        }

        var ps = document.getElementsByTagName("p");
        for(var i = 0, il = ps.length; i < il; i++)
        {
            ps[i].className += " mobile_p";
        }

        var labels = document.getElementsByTagName("label");
        for(var i = 0, il = labels.length; i < il; i++)
        {
            //labels[i].className += " mobile_label";
        }
    }

    function simplify_ui()
    {
        document.getElementById("checks-checkbox-ui").checked = false;
        document.getElementById("factors-checkbox-ui").checked = false;

        if(document.getElementById("simplify-ui").checked)
        {          
            // document.getElementById("selects").style.width = "30%";
            document.getElementById("selects").style.marginLeft = "38%";

            document.getElementById("checks").style.display = "none";
            document.getElementById("factors").style.display = "none";
            //  document.getElementById("additional-info").style.display = "none";
        }    
        else
        {
            document.getElementById("selects").style.marginLeft = "5%";

            document.getElementById("checks").style.display = "inline";
            document.getElementById("factors").style.display = "inline";
            document.getElementById("additional-info").style.display = "inline";
            
            document.getElementById("checks-checkbox-ui").checked = true;
            document.getElementById("factors-checkbox-ui").checked = true;
        }   
    }

    function simplify_ui_partly()
    {
        // As i activate some part of the advanced ui, it is no longer the simplified view, so deactivate it
        document.getElementById("simplify-ui").checked = false;

        // If both are checked, use the simplify_ui function to set everything back to normal, but activate the buttons to make it look 
        if(document.getElementById("checks-checkbox-ui").checked && document.getElementById("factors-checkbox-ui").checked)
        {
            document.getElementById("simplify-ui").checked = false;
            simplify_ui();
        }
        else if(document.getElementById("checks-checkbox-ui").checked && !document.getElementById("factors-checkbox-ui").checked)
        {
            // document.getElementById("selects").style.width = "30%";
            document.getElementById("selects").style.marginLeft = "10%";

            document.getElementById("checks").style.display = "inline";
            document.getElementById("factors").style.display = "none";
        }    
        else if(!document.getElementById("checks-checkbox-ui").checked && document.getElementById("factors-checkbox-ui").checked)
        {
            // document.getElementById("selects").style.width = "30%";
            document.getElementById("selects").style.marginLeft = "10%";

            document.getElementById("checks").style.display = "none";
            document.getElementById("factors").style.display = "inline";
        }
        else 
        {
            document.getElementById("simplify-ui").checked = false;

            document.getElementById("selects").style.marginLeft = "5%";

            document.getElementById("checks").style.display = "inline";
            document.getElementById("factors").style.display = "inline";
            document.getElementById("additional-info").style.display = "inline";
        }

        var date = new Date();
        date.setTime(date.getTime());

        setCookie("partly_check_simplfied_ui", document.getElementById("checks-checkbox-ui").checked, 90);
        setCookie("partly_factor_simplfied_ui", document.getElementById("factors-checkbox-ui").checked, 90);
    }
</script>
</html>