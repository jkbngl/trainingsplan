<html>
<head>
    <title>trainigsplan</title>

    <style>
        .mobile_size button.mobile_button,  button.mobile_button {
           font-size: 35px;
        }

        .mobile_p p.mobile_p,  p.mobile_p {
           font-size: 25px;
        }

        .mobile_span span.mobile_span,  span.mobile_span {
           font-size: 30px;
        }

        .mobile_label label.mobile_label,  label.mobile_label {
           font-size: 30px;
        }
    </style>

    <link rel="stylesheet" type="text/css" href="css/main.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.1/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>



    <script src="http://jakob.ml:8081/auth/js/keycloak.js"></script> 
    <script>
        
        var keycloak = Keycloak();

        keycloak.init({ onLoad: 'login-required' })

        keycloak.init().success(
            function(authenticated) 
            {
                // alert(authenticated ? 'authenticated' : 'not authenticated');
            }
        ).error(function() 
        {
            // alert('failed to initialize');
        }
        );

        keycloak.onAuthSuccess = function() 
        { 
            // alert('Successfully authenticated'); 
            console.log('Successfully authenticated'); 

            username = keycloak.idTokenParsed.name;

            console.log(keycloak.idTokenParsed.name);
            check_roles(keycloak.realmAccess.roles);

            document.getElementById("username").innerHTML = username + ' <i class="fas fa-sign-out-alt"></i>';
        }

        function getusername()
        {
            return username;
        }
    </script>
</head>
<body>
    <div class="fixed-background blue-gradient-bg"></div>

    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()"><i class="fas fa-bars"></i></a>
        <!--<a href="#">About</a>-->
        <!--<button onclick="receivePlanfromDB(false)" class="button" style=" top: 10px; width:80%; margin-left: 10%;">Load Plan</button>
        <button onclick="cleanUpTables(); addTable(true);  closeNav();"class="button" style="top: 10px; width:80%; margin-left: 10%;">New Plan</button>-->
        <button onclick="window.location.href='index.html'" class="button" style="top: 10px; width:80%; margin-left: 10%;"><i class="fas fa-home"></i> Home</button>
        <button onclick="save_settings();"class="button" style="top: 10px; width:80%; margin-left: 10%; margin-top: 20%;"><i class="far fa-save"></i> Save Preferences</button>
        <button onclick="reset_settings();"class="button" style="top: 10px; width:80%; margin-left: 10%;"><i class="fas fa-hammer"></i> Reset Settings</button>
        <button onclick="download();" class="button" style="top: 10px; width:80%; margin-left: 10%; margin-top: 20%;"><i class="fas fa-file-export"></i> Export</button>
        <button onclick="keycloak.logout('/trainingsplanorwhateveritdoesntworkanyway'); kc.logout()"class="button" style="top: 10px; width:80%; margin-left: 10%; "><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>

    <div id = "headerforbuttons" style="display: flex; justify-content: space-between; position:fixed; width:100%">
        <button onclick="openNav()" class="button" style="top: 10px;"><i class="fas fa-bars"></i></span>
            <!-- <button onclick="addTable(true)" class="button" style="top: 10px;">Add new Day</button>-->
            <button onclick="window.location.href='index.html'" class="button" style="top: 10px;" ><i class="fas fa-home"></i> Home</button>
            <button onclick="closeNav(); clear_chart()" class="button" style="top: 10px;" ><i class="fas fa-trash"></i> Clear</button>
            <button onclick="keycloak.logout()" class="button" value="username ..." id="username" style="top: 10px;"></button>
    </div>â€‹

    <div style="position: relative; margin-top: 30px; height: 60vh">
            <canvas id="line-chart" height="100" ></canvas>
        </div>

    <!--
	<div class="divOuter"  >
        <div class="select divInner1"  style="margin-top: 70px; margin-right: 100px; ">
            
        </div>



        <div class="divInner2">
            
        </div>
    </div>
    -->
    

    <div id="container">
        <div style="margin-left:7%;">
            <div class="select" style="width: 80%; border-bottom: 4px solid rgba(0,0,0, 0.12); border-right: 4px solid rgba(0,0,0, 0.12);">
                <select id= "select" onchange="closeNav(); display_ex();" class="select-text" required >
                    <option value="" selected></option>
                </select>
                <span class="select-highlight"></span>
                <span class="select-bar"></span>
                <label style="font-size: 22px;" class="select-label">Analyse an exercise</label>
            </div>
        </div>

        <!------------------->
        <div>
            <div style="float:left; margin-left:3px; margin-right:3px; font-family: inherit;color: #00ad5f; text-align:center; width: 20vw">
                <p style="font-size: 22px; padding-bottom: 6px; border-right: 4px solid rgba(0,0,0, 0.12); text-align:center; ">Choose the &nbsp
                <p style="font-size: 22px; padding-bottom: 6px; border-bottom: 4px solid rgba(0,0,0, 0.12); border-right: 4px solid rgba(0,0,0, 0.12); text-align:center; ">parameter/s &nbsp
            </div>                                            

            <div class="page__toggle" style="margin-top: 100px;">
                <label class="toggle">
                <input id="weight_box" onchange="closeNav();" class="toggle__input" type="checkbox" checked>
                <span class="toggle__label">
                <span class="toggle__text">Weight</span>
                </span>
                </label>
            </div>
            <div class="page__toggle"  style="margin-top: 10px;">
                <label class="toggle">
                <input id="reps_box" onchange="closeNav();" class="toggle__input" type="checkbox" checked>
                <span class="toggle__label">
                <span class="toggle__text">Reps</span>
                </span>
                </label>
            </div>
            <div class="page__toggle"  style="margin-top: 10px;">
                <label class="toggle">
                <input id="sets_box" onchange="closeNav();" class="toggle__input" type="checkbox" checked>
                <span class="toggle__label">
                <span class="toggle__text">Sets</span>
                </span>
                </label>
            </div>
            <div class="page__toggle" style="margin-top: 10px;">
                <label class="toggle">
                <input id="max_rep_box" onchange="closeNav();" class="toggle__input" type="checkbox">
                <span class="toggle__label">
                <span class="toggle__text">Max Rep</span>
                </span>
                </label>
                </div>
            </div>
             <!------------------->
            <div>
                <div style="margin-right:7%;">
                    <div class="slidecontainer" id="weight-slider-div" style="color: #28AD5F; font-size: 14px;" >
                        <p id="weight-slider-button" style="font-size: 22px; padding-bottom: 6px; border-bottom: 6px solid rgba(0,0,0, 0.12); border-right: 4px solid rgba(0,0,0, 0.12); text-align:center; float:left;">Weight Faktor: 5 &nbsp</p>
                        <input type="range" id="weight-slider" min="1" max="20" value="5" class="slider" id="myRange" style="margin-top: 5px; float:right;" oninput=slider_change_w(this.value)>
                    </div>
                    <br><br>
                    <div class="slidecontainer" id="reps-slider-div" style="margin-top: 30px; color: #28AD5F; font-size: 14px;text-align: center;">
                            <p id="reps-slider-button" style="font-size: 22px; padding-bottom: 6px; border-bottom: 6px solid rgba(0,0,0, 0.12); border-right: 4px solid rgba(0,0,0, 0.12); text-align:center; float:left;">Reps Faktor: 5 &nbsp</p>
                            <input type="range" id="reps-slider" min="1" max="20" value="5" class="slider" id="myRange" style="margin-top: 5px; float:right; " oninput=slider_change_r(this.value)>
                    </div>
                    <br><br>
                    <div class="slidecontainer" id="sets-slider-div" style="margin-top: 30px;  color: #28AD5F; font-size: 14px;text-align: center;">
                        <p id="sets-slider-button" style="font-size: 22px; padding-bottom: 6px; border-bottom: 6px solid rgba(0,0,0, 0.12); border-right: 4px solid rgba(0,0,0, 0.12); text-align:center; float:left;">Sets Faktor: 5 &nbsp</p>
                        <input type="range" id="sets-slider" min="1" max="20" value="5" class="slider" id="myRange" style="margin-top: 5px; float:right; " oninput=slider_change_s(this.value)>
                    </div> 
                    <br><br>
                    <div class="slidecontainer" id="max-slider-div" style="margin-top: 30px; color: #28AD5F; font-size: 14px; text-align: center;">
                        <p id="maxrep-slider-button" style="font-size: 22px; padding-bottom: 6px; padding-bottom: 6px; border-bottom: 6px solid rgba(0,0,0, 0.12); border-right: 4px solid rgba(0,0,0, 0.12); text-align:center; float:left;">MaxRep Faktor: 5 &nbsp</p>
                        <input type="range" id="maxrep-slider" min="1" max="20" value="5" class="slider" id="myRange" style="margin-top: 5px; float:right; " oninput=slider_change_m(this.value)>
                    </div>
                </div>
            </div>

            <div id="additional-info" style="width: 0%">
                <!--
                    <button onclick="window.location.href='index.html'" class="button" style="top: 10px; width:80%; margin-left: 10%;"><i class="fas fa-home"></i> Home</button>
                -->
            </div>
        </div>

        
</body>

<script>
    // Used to determine which color the line should have, gets set to 0 after all numbers are used and starts again at zero
    var num_ex_color = 0;
    // Used to get an overview how many exexercises are displayed and close or open the div in which additional info about the exercises can be get
    var num_ex = 0;

    function download() 
    {
        var url_base64 = document.getElementById('line-chart').toDataURL('image/png');
        var element = document.createElement('a');
        
        element.setAttribute('href', url_base64);
        element.setAttribute('download', 'chart.png');
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    }

    function reset_settings()
    {
        document.getElementById("weight-slider").value = 2;
        document.getElementById("reps-slider").value = 2;
        document.getElementById("sets-slider").value = 2;
        document.getElementById("maxrep-slider").value = 2;


        document.getElementById("weight-slider-button").innerHTML = "Weight Faktor: " + 2 + " &nbsp";
        document.getElementById("reps-slider-button").innerHTML = "Reps Faktor: " + 2 + " &nbsp";
        document.getElementById("sets-slider-button").innerHTML = "Sets Faktor: " + 2 + " &nbsp";
        document.getElementById("maxrep-slider-button").innerHTML = "MaxRep Faktor: " + 2 + " &nbsp";


        document.getElementById("weight_box").checked = true;
        document.getElementById("reps_box").checked = true;
        document.getElementById("sets_box").checked = true;
        document.getElementById("max_rep_box").checked = false;
    }

    function slider_change_w(value)
    {
        document.getElementById("weight-slider-button").innerHTML = "Weight Faktor: " + value + " &nbsp";
    }

    function slider_change_r(value)
    {
        document.getElementById("reps-slider-button").innerHTML = "Reps Faktor: " + value + " &nbsp";
    }

    function slider_change_s(value)
    {
        document.getElementById("sets-slider-button").innerHTML = "Sets Faktor: " + value + " &nbsp";
    }

    function slider_change_m(value)
    {
        document.getElementById("maxrep-slider-button").innerHTML = "MaxRep Faktor: " + value + " &nbsp";
    }

    function check_roles(assigned_roles)
    {
        var roles = [];

        for(var i = 0; i < assigned_roles.length; i++)
        {
            if(assigned_roles[i] == 'paid_account' || assigned_roles[i] == 'friend_account')
                roles[0] = assigned_roles[i];
        }

        var superaccount = (roles.indexOf("friend_account") > -1) || (roles.indexOf("paid_account") > -1);

        if(!superaccount)
        {
            alert("Access denied!");
            window.location.href='index.html'
        }
        else
        {
            //alert("Access granted!");
        }
    }
    

    function get_available_ex()
    {
        var request = new XMLHttpRequest();
        var url = 'http://jakob.ml:50003/trainingsplan/get_possible_base_exs/';
        var username = getusername();
        var xmlHttp = new XMLHttpRequest();

        xmlHttp.open( "GET", url + username, false ); // false for synchronous request
        xmlHttp.send( null );
        available_ex = xmlHttp.responseText;

        return available_ex;
    }

    function append_combo(json_base_exs)
    {
        var json = JSON.parse(json_base_exs);
        var exercises = document.getElementById('select');

        for(var i = 0; i < json.base_exs.length; i++) 
        {
            var opt = document.createElement('option');
            opt.value = json.base_exs[i].base_ex;
            opt.innerHTML = json.base_exs[i].name + " - " + json.base_exs[i].planname;
            opt.id = 'option_element';
            exercises.appendChild(opt);
        }
    }

    function append_preferences()
    {
        var request = new XMLHttpRequest();
        var url = 'http://jakob.ml:50003/trainingsplan/get_preferences/';
        var xmlHttp = new XMLHttpRequest();

        xmlHttp.open( "GET", url + getusername(), false ); // false for synchronous request
        xmlHttp.send( null );
        preferences = xmlHttp.responseText;

        var json = JSON.parse(preferences);
        
        if(json.check_weight == 't')
            document.getElementById("weight_box").checked = true;
        else if(typeof json.check_weight == 'undefined')
            document.getElementById("weight_box").checked = true;            
        else
            document.getElementById("weight_box").checked = false;

        if(json.check_reps == 't')
            document.getElementById("reps_box").checked = true;
        else if(typeof json.check_reps == 'undefined')
            document.getElementById("reps_box").checked = true;
        else
            document.getElementById("reps_box").checked = false;

        if(json.check_sets == 't')
            document.getElementById("sets_box").checked = true;
        else if(typeof json.check_sets == 'undefined')
            document.getElementById("sets_box").checked = true;
        else
            document.getElementById("sets_box").checked = false;

        // if undefined dont set because default is unselected
        if(json.check_maxrep == 't')
            document.getElementById("max_rep_box").checked = true;
        else
            document.getElementById("max_rep_box").checked = false;


        document.getElementById("weight-slider-button").innerHTML = 'Weight Faktor: ' + json.mul_weight + ' &nbsp';
        document.getElementById("sets-slider-button").innerHTML = 'Reps Faktor: ' + json.mul_reps + ' &nbsp';
        document.getElementById("reps-slider-button").innerHTML = 'Sets Faktor: ' + json.mul_sets + ' &nbsp';
        document.getElementById("maxrep-slider-button").innerHTML = 'MaxRep Faktor: ' + json.mul_maxrep + ' &nbsp';

        document.getElementById("weight-slider").value = json.mul_weight;
        document.getElementById("reps-slider").value = json.mul_reps;
        document.getElementById("sets-slider").value = json.mul_sets;
        document.getElementById("maxrep-slider").value = json.mul_maxrep;


    }

    function display_ex() {
        var values = [];
        var e = document.getElementById("select");
        var value = e.options[e.selectedIndex].value;
        var text = e.options[e.selectedIndex].text;

        console.log(text + " | " + value)

        var request = new XMLHttpRequest();
        var url = 'http://jakob.ml:50003/trainingsplan/get_stats/';
        var xmlHttp = new XMLHttpRequest();

        xmlHttp.open( "GET", url + value, false ); // false for synchronous request
        xmlHttp.send( null );
        available_ex = xmlHttp.responseText;

        console.log(available_ex);

        var weight_box = document.getElementById("weight_box");
        var reps_box = document.getElementById("reps_box");
        var sets_box = document.getElementById("sets_box");
        var max_rep_box = document.getElementById("max_rep_box");

        values = get_value(available_ex, weight_box.checked, reps_box.checked, sets_box.checked, max_rep_box.checked);

        addData(values, text, available_ex);


    }

    function get_value(json_ex, weight, reps, sets, max_rep) {

        var json = JSON.parse(json_ex);
        var values = [];
        var mul_weight = document.getElementById("weight-slider").value;
        var mul_reps   = document.getElementById("reps-slider").value;
        var mul_sets   = document.getElementById("sets-slider").value;
        var mul_max_rep = document.getElementById("maxrep-slider").value;

        for(var i = 0; i < json.values.length; i++) 
        {
            // to avoid multiplying * 0
            values[i] = 1;

            // Dont use else if because multiple checkboxes can be checked
            if(weight && typeof(json.values[i].weight) != 'undefined' && json.values[i].weight != null && json.values[i].weight.length > 0)
                if(json.values[i].weight.match(/\d/g).join("") > 0)
                    values[i] *= json.values[i].weight.match(/\d/g).join("");
            
            if(weight && typeof(json.values[i].reps) != 'undefined' && json.values[i].reps != null && json.values[i].reps.length > 0)
                if(json.values[i].reps.match(/\d/g).join("") > 0)
                    values[i] *= json.values[i].reps.match(/\d/g).join("");
            
            if(weight && typeof(json.values[i].sets) != 'undefined' && json.values[i].sets != null && json.values[i].sets.length > 0)
                if(json.values[i].sets.match(/\d/g).join("") > 0)
                    values[i] *= json.values[i].sets.match(/\d/g).join("");
            
            if(weight && typeof(json.values[i].max_rep) != 'undefined' && json.values[i].max_rep != null && json.values[i].max_rep.length > 0)
                if(json.values[i].max_rep.match(/\d/g).join("") > 0)
                    values[i] *= json.values[i].max_rep.match(/\d/g).join("");
        }

        return values;
    }

    function addData(values, ex_name, all_ex)
    {
        console.log(values);

        chart.data.datasets.push({
            data: values,
            label: ex_name,
            borderColor: border_color_array[num_ex_color],
            fill: false
        });

        if(num_ex_color == border_color_array.length - 1)
            num_ex_color = 0;
        else
            num_ex_color++;


        // needs to be checked before numbers gets increased
        change_div(num_ex, all_ex, false);
        num_ex++;

        chart.update();
    }

    function change_div(num_ex, values, reset)
    {
        if(reset)
            document.getElementById("additional-info").style.width = "0%";
        else
        {
            if(num_ex == 0)
                document.getElementById("additional-info").style.width = "25%";
            
            
        }
    }

    function clear_chart()
    {
        chart.reset();
        chart.clear();
        chart = create_chart();
        
        change_div(0,0, true);
        num_ex = 0;
        console.log(num_ex);
    }

    var labels = [1,2,3,4,5,6,7,8];
    var border_color_array = ["#00ad5f", "#E3170A", "#F7B32B", "#8980F5", "#102542", "#0EB1D2", "#41658A", "#A9E5BB", "#1A3A3A", "#0EB1D2"];
    var ex_names = ["kniebeuge", "bankdruecken", "seitheben", "latzug"];

    var chart = create_chart();

    function create_chart()
    {
        var chart = new Chart(document.getElementById("line-chart"), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    
                ]
            },
            options: {
                title: {
                    display: false,
                    text: 'Trainingsplan'
                },
                legend: {
                    display: true,
                    labels: {
                        fontSize: 20
                    }
                },
                tooltips: {
                    enabled: true,
                    mode: 'single',
                    callbacks: {
                        label: function(tooltipItems, data) { 
                            var label = data.datasets[tooltipItems.datasetIndex].label || '';
                            get_data_per_exercise_and_step(tooltipItems.xLabel, label);
                            return tooltipItems.xLabel + " | " + label + "<br>" + "-";
                        }
                    }
                },            
                responsive: true,
                maintainAspectRatio: false

            }
         });

         return chart;
        }

    function get_data_per_exercise_and_step(index, name)
    {
        
    }

    function openNav()
    {
        if( isMobile.any() ) 
        {
            document.getElementById("mySidenav").style.width = "300px";
        }
        else
        {
            document.getElementById("mySidenav").style.width = "250px";
        }   
    }

    function closeNav()
    {
        document.getElementById("mySidenav").style.width = "0";
    }

    function save_settings()
    {
        var preferences = {}; 

        preferences.username = getusername(); 
        preferences.check_weight = document.getElementById("weight_box").checked;
        preferences.check_reps = document.getElementById("reps_box").checked;
        preferences.check_sets = document.getElementById("sets_box").checked;
        preferences.check_maxrep = document.getElementById("max_rep_box").checked;
        preferences.mul_weight = document.getElementById('weight-slider').value;
        preferences.mul_reps = document.getElementById('reps-slider').value;
        preferences.mul_sets = document.getElementById('sets-slider').value;
        preferences.mul_maxrep = document.getElementById('maxrep-slider').value
        
        var xhr = new XMLHttpRequest();
        var url = "http://jakob.ml:50003/trainingsplan/send_preferences";
        xhr.open("POST", url, true);
        xhr.setRequestHeader("Content-Type", "text/plain");
        var string = JSON.stringify(preferences);

        xhr.send(string);
        alert("Preferences saved!");
    }

    var isMobile = {
        Android: function() {
            return navigator.userAgent.match(/Android/i);
        },
        BlackBerry: function() {
            return navigator.userAgent.match(/BlackBerry/i);
        },
        iOS: function() {
            return navigator.userAgent.match(/iPhone|iPad|iPod/i);
        },
        Opera: function() {
            return navigator.userAgent.match(/Opera Mini/i);
        },
        Windows: function() {
            return navigator.userAgent.match(/IEMobile/i) || navigator.userAgent.match(/WPDesktop/i);
        },
        any: function() {
            return (isMobile.Android() || isMobile.BlackBerry() || isMobile.iOS() || isMobile.Opera() || isMobile.Windows());
        }
    };

    function customize_mobile()
    {
        document.getElementById("headerforbuttons").style.height = "75px";
        chart.options.legend.labels.fontSize = 30;
        document.getElementById("weight-slider").style.width = "90%";
        document.getElementById("reps-slider").style.width = "90%";
        document.getElementById("sets-slider").style.width = "90%";
        document.getElementById("maxrep-slider").style.width = "90%";

        /*
        document.getElementById("weight-slider").style.height = "2.5%";
        document.getElementById("reps-slider").style.height = "2.5%";
        document.getElementById("sets-slider").style.height = "2.5%";
        document.getElementById("maxrep-slider").style.height = "2.5%";
        */

        document.getElementById("weight-slider").style.float = "left";
        document.getElementById("reps-slider").style.float = "left";
        document.getElementById("sets-slider").style.float = "left";
        document.getElementById("maxrep-slider").style.float = "left";

        //document.getElementById("weight-slider-div").style.padding = "200px"; doesnt need as it is the first
        document.getElementById("reps-slider-div").style.marginTop = "80px";
        document.getElementById("sets-slider-div").style.marginTop = "80px";
        document.getElementById("max-slider-div").style.marginTop = "80px";

        document.getElementById("max-slider-div").style.marginTop = "80px";


        var buttons = document.getElementsByTagName("button");
        for(var i = 0, il = buttons.length; i < il; i++)
        {
            buttons[i].className += " mobile_button";
        }

        var spans = document.getElementsByTagName("span");
        for(var i = 0, il = spans.length; i < il; i++)
        {
            spans[i].className += " mobile_span";
        }

        var ps = document.getElementsByTagName("p");
        for(var i = 0, il = ps.length; i < il; i++)
        {
            ps[i].className += " mobile_p";
        }

        var labels = document.getElementsByTagName("label");
        for(var i = 0, il = labels.length; i < il; i++)
        {
            //labels[i].className += " mobile_label";
        }
    }

    document.addEventListener('DOMContentLoaded', function()
    {
        var available_ex;
        var check = function()
        {
            if(getusername().length > 0){
                available_ex = get_available_ex();            
                append_combo(available_ex);
                append_preferences();

                if( isMobile.any() ) 
                {
                    // console.log("MOBILE DETECTED AS DEVICE");
                    customize_mobile();
                }
                else
                {
                    //customize_mobile();
                    //console.log("PC DETECTED AS DEVICE");
                    ;
                }
            }
            else
            {
                setTimeout(check, 10); // check again in 10 ms
            }
        }
        
        check();

        
    }, false);
</script>
</html>