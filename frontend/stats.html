<html>
<head>
    <title>trainigsplan</title>

    <style>
        .mobile_size button.mobile_button,  button.mobile_button {
           font-size: 35px;
        }

        .mobile_p p.mobile_p,  p.mobile_p {
           font-size: 25px;
        }

        .mobile_span span.mobile_span,  span.mobile_span {
           font-size: 30px;
        }

        .mobile_label label.mobile_label,  label.mobile_label {
           font-size: 30px;
        }
    </style>

    <link rel="stylesheet" type="text/css" href="css/main.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.1/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@8"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@1/dark.css">




    <script src="http://jakob.ml:8081/auth/js/keycloak.js"></script> 
    <script>
        var keycloak;

        function display_error(type, title, message)
        {
            var footer = '<hr style="height: 2px; background-color:#666;"><br>';

            console.log(message);

            if(message.includes('backend') && message.includes('unavailable') || message.includes('Authentification'))
                footer += message + '<br><br><a href onclick="location.reload()">Reload the Page!</button><br>';

            if(type == 'error')
                footer += '<a href="https://github.com/jkbngl/trainingsplan/issues/new">If you think this is not correct please open a github issue!</a>'
                
            footer += '<br><br><hr style="height: 2px; background-color:#666;"><br>';

            Swal.fire({
              type: type,
              title: title,
              html: footer
            })
        }

        document.addEventListener('DOMContentLoaded',function(){
            try
            {
                keycloak = Keycloak();

                keycloak.init({ onLoad: 'login-required' })

                keycloak.init().success(
                    function(authenticated) 
                    {
                        // alert(authenticated ? 'authenticated' : 'not authenticated');
                    }
                ).error(function() {
                    // alert('failed to initialize');
                });

                keycloak.onAuthSuccess = function() 
                { 
                    // alert('Successfully authenticated'); 
                    console.log('Successfully authenticated'); 
                
                    username = keycloak.idTokenParsed.name;
                    username = username.toLowerCase();
                    check_roles(keycloak.realmAccess.roles);
                
                    document.getElementById("username").innerHTML = username + ' <i class="fas fa-sign-out-alt"></i>';
                
                    var available_ex = get_available_ex();            
                    append_combo(available_ex);
                    data = append_preferences();
                
                    if(data.check_chart_type == 'f' /* || typeof data.check_chart_type == 'undefined'*/)
                    {
                        chart_type = 'line';
                        chart = create_chart(chart_type);
                    }    
                    else
                    {
                        // if undefined as above, make bar chart default and make it checked
                        //document.getElementById("chart-type").checked = true;
                        chart_type = 'bar';
                        chart = create_chart(chart_type);
                    }
                
                
                    if( isMobile.any() ) 
                        customize_mobile();
                    else
                        ;
                }
            }
            catch(err)
            {
                console.log("error");
                display_error("error", "Ooops...", "Error with Authentification, please try again at a later point");
                window.stop() 
            }
        });

        function getusername()
        {
            return username;
        }
    </script>
</head>
<body>
    <div class="fixed-background blue-gradient-bg"></div>

    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()"><i class="fas fa-bars"></i></a>
        <!--<a href="#">About</a>-->
        <!--<button onclick="receivePlanfromDB(false)" class="button" style=" top: 10px; width:80%; margin-left: 10%;">Load Plan</button>
        <button onclick="cleanUpTables(); addTable(true);  closeNav();"class="button" style="top: 10px; width:80%; margin-left: 10%;">New Plan</button>-->
        <button onclick="window.location.href='index.html'" class="button" style="top: 10px; width:80%; margin-left: 10%;"><i class="fas fa-home"></i> Home</button>
        <!--<button onclick="save_settings(); update_chart();"                  class="button" style="top: 10px; width:80%; margin-left: 10%; margin-top: 20%;"><i class="far fa-save"></i> Save Preferences</button>-->
        
                
       
        <button onclick="reset_settings(); save_settings()"class="button" style="top: 10px; width:80%; margin-left: 10%;"><i class="fas fa-hammer"></i> Reset Settings</button>
        <button onclick="download();" class="button" style="top: 10px; width:80%; margin-left: 10%; margin-top: 20%;"><i class="fas fa-file-export"></i> Export</button>
        <button onclick="keycloak.logout('/trainingsplanorwhateveritdoesntworkanyway'); kc.logout()"class="button" style="top: 10px; width:80%; margin-left: 10%; "><i class="fas fa-sign-out-alt"></i> Logout</button>

        <div class="page__toggle" style="margin-left: 10%; margin-top: 12%;">
            <label class="toggle">
            <input id="simplify-ui" onchange="closeNav();" onclick="simplify_ui(); save_settings();" class="toggle__input" type="checkbox">
            <span class="toggle__label">
                <span class="toggle__text">Simple interface 
                    <i class="fas fa-info-circle" rel="tooltip" title="If simple Interface is turned on, the website will use the default values (check what the default settings are by clicking reset settings above, Attention: old settings will be lost) and in addition make the interface simpler by not showing the advanced settings" id="info-step-2"></i>
                </span>
            </span>
            </label>
        </div>

        <div class="page__toggle" style="margin-left: 20%; margin-top: 7%;">
            <label class="toggle">
            <input id="factors-checkbox-ui" onclick="simplify_ui_partly(); save_settings();" class="toggle__input" type="checkbox">
            <span class="toggle__label">
                <span class="toggle__text">Show Factors 
                    <i class="fas fa-info-circle" rel="tooltip" title="If this checkbox is active you can access the part of the advanced ui where you can change the factors per attribute" id="info-step-2"></i>
                </span>
            </span>
            </label>
        </div>
        <div class="page__toggle" style="margin-left: 20%; margin-top: 5%;">
            <label class="toggle">
            <input id="checks-checkbox-ui" onclick="simplify_ui_partly(); save_settings();" class="toggle__input" type="checkbox">
            <span class="toggle__label">
                <span class="toggle__text">Show Checks
                    <i class="fas fa-info-circle" rel="tooltip" title="If this checkbox is active you can access the part of the advanced ui where you can change the attributes that should be used to calc the data in the chart" id="info-step-2"></i>
                </span>
            </span>
            </label>
        </div>





        <div class="page__toggle" style="margin-left: 10%; margin-top: 25%;">
            <label class="toggle">
            <input id="chart-type" onchange="closeNav();" onclick="change_chart(); save_settings();" class="toggle__input" type="checkbox">
            <span class="toggle__label">
                <span class="toggle__text">Bar Chart 
                    <i class="fas fa-info-circle" rel="tooltip" title="Change between the normal line chart and the bar chart to analyze your data" id="info-step-2"></i>
                </span>
            </span>
            </label>
        </div>
    </div>

    <div id = "headerforbuttons" style="display: flex; justify-content: space-between; position:fixed; width:100%">
        <button onclick="openNav()" class="button" style="top: 10px;"><i class="fas fa-bars"></i></span>
            <!-- <button onclick="addTable(true)" class="button" style="top: 10px;">Add new Day</button>-->
            <button onclick="window.location.href='index.html'" class="button" style="top: 10px;" ><i class="fas fa-home"></i> Home</button>
            <button onclick="closeNav(); clear_chart(true)" class="button" style="top: 10px;" ><i class="fas fa-trash"></i> Clear</button>
            <button onclick="keycloak.logout()" class="button" value="username ..." id="username" style="top: 10px;"></button>
    </div>â€‹

    <div id="div-line-chart" style="position: relative; margin-top: 30px; height: 60vh;">
        <canvas id="line-chart" height="100"></canvas>
        <canvas id="line-chart" height="100"></canvas>        
    </div>

    <div id="container">
        
        <!------------------->
        <div id="selects" style="margin-left:5%; margin-top:5%">

            <div class="select" style="width: 80%; border-bottom: 4px solid rgba(0,0,0, 0.12); border-right: 4px solid rgba(0,0,0, 0.12); ">
                <select id= "select" onchange="closeNav(); display_ex();" class="select-text" required >
                    <option value="" selected></option>
                </select>
                <span class="select-highlight"></span>
                <label style="font-size: 22px;" class="select-label">1. Choose an exercise
                        <i class="fas fa-info-circle" rel="tooltip" title="Select an exercise from this list to have the history (if existent) of your data displayed in the chart above  " id="info-step-1"></i>
                        </label>
                <span class="select-bar"></span>
            </div>
        </div>

        <!------------------->
        <div id="checks">
            <div style="float:left; margin-left:3px; margin-right:3px; font-family: inherit; color: #00ad5f; text-align:center; width: 20vw">
                <!-- <p style="font-size: 22px; padding-bottom: 6px; border-right: 4px solid rgba(0,0,0, 0.12); text-align:center; ">Choose the &nbsp-->
                <p style="font-size: 22px; padding-bottom: 6px; border-bottom: 4px solid rgba(0,0,0, 0.12); border-right: 4px solid rgba(0,0,0, 0.12); text-align:center; "> 2. Choose the parameter/s &nbsp
                <i class="fas fa-info-circle" rel="tooltip" title="If you deselect/ select parameters from this list they will either be used to calculate your stats or not" id="info-step-2"></i>
            </div>                                            

            <div class="page__toggle" style="margin-top: 12%;">
                <label class="toggle">
                <input id="weight_box" onchange="closeNav();" onclick="save_settings(); update_chart();" class="toggle__input" type="checkbox" checked>
                <span class="toggle__label">
                <span class="toggle__text">Weight</span>
                </span>
                </label>
            </div>
            <div class="page__toggle"  style="margin-top: 10px;">
                <label class="toggle">
                <input id="reps_box" onchange="closeNav();" onclick="save_settings(); update_chart();"  class="toggle__input" type="checkbox" checked>
                <span class="toggle__label">
                <span class="toggle__text">Reps</span>
                </span>
                </label>
            </div>
            <div class="page__toggle"  style="margin-top: 10px;">
                <label class="toggle">
                <input id="sets_box" onchange="closeNav();" onclick="save_settings(); update_chart();"  class="toggle__input" type="checkbox" checked>
                <span class="toggle__label">
                <span class="toggle__text">Sets</span>
                </span>
                </label>
            </div>
            <div class="page__toggle" style="margin-top: 10px;">
                <label class="toggle">
                <input id="max_rep_box" onchange="closeNav();" onclick="save_settings(); update_chart();" class="toggle__input" type="checkbox">
                <span class="toggle__label">
                <span class="toggle__text">Max Rep</span>
                </span>
                </label>
                </div>
        </div>
        <!------------------->
        <div id="factors">
            <div style="float:left; margin-left:3px; margin-right:3px; font-family: inherit; color: #00ad5f; text-align: center; width: 20vw; padding-bottom: 2%">
                <p style="font-size: 22px; padding-bottom: 6px; border-bottom: 4px solid rgba(0,0,0, 0.12); border-right: 4px solid rgba(0,0,0, 0.12); text-align:center; padding-bottom: 2%">3. Change the Factors/s &nbsp
                <i class="fas fa-info-circle" rel="tooltip" title="If you change the value of the slider the values will be multiplicated with your weight/ reps/ etc. This can be useful if you want to have more focus on one factor" id="info-step-3"></i>
            </div>

            <div style="margin-right:7%;">
                <div class="slidecontainer" id="weight-slider-div" style="color: #28AD5F; font-size: 14px;" >
                    <p id="weight-slider-button" style="font-size: 22px; padding-bottom: 6px; border-bottom: 6px solid rgba(0,0,0, 0.12); border-right: 4px solid rgba(0,0,0, 0.12); text-align:center; float:left; padding-top: 2%;">Weight Faktor: 1 &nbsp&nbsp&nbsp</p>
                    <input type="range" id="weight-slider" min="1" max="20" value="1" class="slider" id="myRange" style="margin-top: 5px; float:right;" ontouchend="save_settings(); update_chart();" onmouseup="save_settings(); update_chart();" oninput=slider_change_w(this.value)>
                </div>
                <br><br>
                <div class="slidecontainer" id="reps-slider-div" style="margin-top: 30px; color: #28AD5F; font-size: 14px;text-align: center; padding-top: 7%;">
                        <p id="reps-slider-button" style="font-size: 22px; padding-bottom: 6px; border-bottom: 6px solid rgba(0,0,0, 0.12); border-right: 4px solid rgba(0,0,0, 0.12); text-align:center; float:left; ">Reps Faktor: 1 &nbsp</p>
                        <input type="range" id="reps-slider" min="1" max="20" value="1" class="slider" id="myRange" style="margin-top: 5px; float:right; " ontouchend="save_settings(); update_chart();" onmouseup="save_settings(); update_chart();" oninput=slider_change_r(this.value)>
                </div>
                <br><br>
                <div class="slidecontainer" id="sets-slider-div" style="margin-top: 30px;  color: #28AD5F; font-size: 14px;text-align: center;">
                    <p id="sets-slider-button" style="font-size: 22px; padding-bottom: 6px; border-bottom: 6px solid rgba(0,0,0, 0.12); border-right: 4px solid rgba(0,0,0, 0.12); text-align:center; float:left;">Sets Faktor: 1 &nbsp</p>
                    <input type="range" id="sets-slider" min="1" max="20" value="1" class="slider" id="myRange" style="margin-top: 5px; float:right; " ontouchend="save_settings(); update_chart();" onmouseup="save_settings(); update_chart();" oninput=slider_change_s(this.value)>
                </div> 
                <br><br>
                <div class="slidecontainer" id="max-slider-div" style="margin-top: 30px; color: #28AD5F; font-size: 14px; text-align: center;">
                    <p id="maxrep-slider-button" style="font-size: 22px; padding-bottom: 6px; padding-bottom: 6px; border-bottom: 6px solid rgba(0,0,0, 0.12); border-right: 4px solid rgba(0,0,0, 0.12); text-align:center; float:left;">MaxRep Faktor: 1 &nbsp</p>
                    <input type="range" id="maxrep-slider" min="1" max="20" value="1" class="slider" id="myRange" style="margin-top: 5px; float:right; " ontouchend="save_settings(); update_chart();" onmouseup="save_settings(); update_chart();" oninput=slider_change_m(this.value)>
                </div>
            </div>
        </div>
        <!------------------->
        <div id="additional-info" style="width: 0%">
            <!--
                <button onclick="window.location.href='index.html'" class="button" style="top: 10px; width:80%; margin-left: 10%;"><i class="fas fa-home"></i> Home</button>
            -->
        </div>
    </div>

        
</body>

<script>
    // Object to store data for all actively displayed data in chart
    var active_ex_in_chart = [

    ];

    // Used to determine which color the line should have, gets set to 0 after all numbers are used and starts again at zero
    var num_ex_color = 0;
    // Used to get an overview how many exexercises are displayed and close or open the div in which additional info about the exercises can be get
    var num_ex = 0;

    // global variable to handle the creation and destruction of chart easily
    var chart;
    // global variable to handle the creation and destruction of different chart easily, line = default
    var chart_type = 'line';

    function download() 
    {
        if(num_ex > 0)
        {
            // Get the data to save the file with different names #
            // TODO read active_ex_in_chart and add ex names
            
            var url_base64 = document.getElementById('line-chart').toDataURL('image/png');
            var element = document.createElement('a');
            
            element.setAttribute('href', url_base64);
            element.setAttribute('download', 'chart_' + get_date() + '.png');
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }
        else
        {
            alert("Nothing to export!");
        }
    }

    function get_date()
    {
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
        var yyyy = today.getFullYear();

        return mm + '_' + dd + '_' + yyyy;
    }

    // Changing is only possible with the last choosen ex so use this number
    // TODO: will maybe be changed later - add value to buttons of ex and return the value to this function
    function update_chart()
    {
        if(num_ex > 0)
        {
            var values = [];

            var chart_to_change = num_ex - 1;
           

            for(var j = 0; j <= chart_to_change; j++)
            {
                var length_of_chart = chart.data.datasets[j].data.length;
                // Get the last added exercise
                var data = active_ex_in_chart[j];

                values = get_value(data,  document.getElementById("weight_box").checked
                                        , document.getElementById("reps_box").checked
                                        , document.getElementById("sets_box").checked
                                        , document.getElementById("max_rep_box").checked);

                console.log(data);    
            
                for(var i = 0; i < length_of_chart; i++)
                {
                    chart.data.datasets[j].data[i] = values[i];
                }
            }

            console.log("---------------------------"); 
            

            chart.update();
        }
        
    }

    function reset_settings()
    {
        document.getElementById("weight-slider").value = 1;
        document.getElementById("reps-slider").value = 1;
        document.getElementById("sets-slider").value = 1;
        document.getElementById("maxrep-slider").value = 1;

        document.getElementById("weight-slider-button").innerHTML = "Weight Faktor: " + 1 + " &nbsp&nbsp&nbsp";
        document.getElementById("reps-slider-button").innerHTML = "Reps Faktor: " + 1 + " &nbsp";
        document.getElementById("sets-slider-button").innerHTML = "Sets Faktor: " + 1 + " &nbsp";
        document.getElementById("maxrep-slider-button").innerHTML = "MaxRep Faktor: " + 1 + " &nbsp";

        document.getElementById("weight_box").checked = true;
        document.getElementById("reps_box").checked = true;
        document.getElementById("sets_box").checked = true;
        document.getElementById("max_rep_box").checked = false;
    }

    function slider_change_w(value)
    {
        document.getElementById("weight-slider-button").innerHTML = "Weight Faktor: " + value + " &nbsp&nbsp&nbsp";
    }

    function slider_change_r(value)
    {
        document.getElementById("reps-slider-button").innerHTML = "Reps Faktor: " + value + " &nbsp";
    }

    function slider_change_s(value)
    {
        document.getElementById("sets-slider-button").innerHTML = "Sets Faktor: " + value + " &nbsp";
    }

    function slider_change_m(value)
    {
        document.getElementById("maxrep-slider-button").innerHTML = "MaxRep Faktor: " + value + " &nbsp";
    }

    function check_roles(assigned_roles)
    {
        var roles = [];

        for(var i = 0; i < assigned_roles.length; i++)
        {
            if(assigned_roles[i] == 'paid_account' || assigned_roles[i] == 'friend_account')
                roles[0] = assigned_roles[i];
        }

        var superaccount = (roles.indexOf("friend_account") > -1) || (roles.indexOf("paid_account") > -1);

        if(!superaccount)
        {
            alert("Access denied!");
            window.location.href='index.html'
        }
        else
        {
            //alert("Access granted!");
        }
    }
    

    function get_available_ex()
    {
        var request = new XMLHttpRequest();
        var url = 'http://jakob.ml:50003/trainingsplan/get_possible_base_exs/';
        var username = getusername();

        try
        {
            var xmlHttp = new XMLHttpRequest();

            xmlHttp.open( "GET", url + username, false ); // false for synchronous request
            xmlHttp.send( null );
            available_ex = xmlHttp.responseText;

            return available_ex;
        }
        catch(err)
        {
            display_error('error', 'Oops...', 'The backend seems to be unavailable!')
        }
    }

    function append_combo(json_base_exs)
    {
        console.log(json_base_exs);

        var json = JSON.parse(json_base_exs);
        var exercises = document.getElementById('select');

        for(var i = 0; i < json.base_exs.length; i++) 
        {
            var opt = document.createElement('option');
            opt.value = json.base_exs[i].base_ex;
            opt.innerHTML = json.base_exs[i].name + " - " + json.base_exs[i].planname;
            opt.id = 'option_element';
            exercises.appendChild(opt);
        }
    }

    function append_preferences()
    {
        var request = new XMLHttpRequest();
        var url = 'http://jakob.ml:50003/trainingsplan/get_preferences/';
        var xmlHttp = new XMLHttpRequest();

        xmlHttp.open( "GET", url + getusername(), false ); // false for synchronous request
        xmlHttp.send( null );
        preferences = xmlHttp.responseText;

        var json = JSON.parse(preferences);
        
        if(json.check_weight == 't')
            document.getElementById("weight_box").checked = true;
        else if(typeof json.check_weight == 'undefined')
            document.getElementById("weight_box").checked = true;            
        else
            document.getElementById("weight_box").checked = false;

        if(json.check_reps == 't')
            document.getElementById("reps_box").checked = true;
        else if(typeof json.check_reps == 'undefined')
            document.getElementById("reps_box").checked = true;
        else
            document.getElementById("reps_box").checked = false;

        if(json.check_sets == 't')
            document.getElementById("sets_box").checked = true;
        else if(typeof json.check_sets == 'undefined')
            document.getElementById("sets_box").checked = true;
        else
            document.getElementById("sets_box").checked = false;

        // if undefined dont set because default is unselected
        if(json.check_maxrep == 't')
            document.getElementById("max_rep_box").checked = true;
        else
            document.getElementById("max_rep_box").checked = false;

        // if undefined dont set because default is unselected -
        if(json.check_simple_view == 't')
        {
            document.getElementById("simplify-ui").checked = true;
            simplify_ui();
        }
        else
        {
            document.getElementById("simplify-ui").checked = false;
            simplify_ui();
        }

        // if undefined dont set because default is unselected
        if(json.check_chart_type == 't')
        {
            document.getElementById("chart-type").checked = true;
            create_chart("bar");
        }
        else
        {
            document.getElementById("chart-type").checked = false;
            create_chart("line");
        }

        if(does_json_contain_data(json))
        {
            document.getElementById("weight-slider-button").innerHTML = 'Weight Faktor: ' + json.mul_weight + ' &nbsp&nbsp&nbsp';
            document.getElementById("reps-slider-button").innerHTML = 'Reps Faktor: ' + json.mul_reps + ' &nbsp';
            document.getElementById("sets-slider-button").innerHTML = 'Sets Faktor: ' + json.mul_sets + ' &nbsp';
            document.getElementById("maxrep-slider-button").innerHTML = 'MaxRep Faktor: ' + json.mul_maxrep + ' &nbsp';

            document.getElementById("weight-slider").value = json.mul_weight;
            document.getElementById("reps-slider").value = json.mul_reps;
            document.getElementById("sets-slider").value = json.mul_sets;
            document.getElementById("maxrep-slider").value = json.mul_maxrep;
        }

        return json;
    }

    function does_json_contain_data(object) 
    {
        for(var i in object)
        {
            return true;
        }
        
        return false; 
    } 

    function display_ex() {
        var values = [];
        var e = document.getElementById("select");
        var value = e.options[e.selectedIndex].value;
        var text = e.options[e.selectedIndex].text;

        console.log(" exercise name + plan name: " + text)

        try
        {
            var request = new XMLHttpRequest();
            var url = 'http://jakob.ml:50003/trainingsplan/get_stats/';
            var xmlHttp = new XMLHttpRequest();

            xmlHttp.open( "GET", url + value, false ); // false for synchronous request
            xmlHttp.send( null );
            available_ex = xmlHttp.responseText;

            console.log(available_ex);

            var weight_box = document.getElementById("weight_box");
            var reps_box = document.getElementById("reps_box");
            var sets_box = document.getElementById("sets_box");
            var max_rep_box = document.getElementById("max_rep_box");

            values = get_value(available_ex, weight_box.checked, reps_box.checked, sets_box.checked, max_rep_box.checked);


            // push the data into a global object which is accessible for the function which updates the chart dynamically
            active_ex_in_chart.push(available_ex);

            addData(values, text, available_ex);
        }
        catch(err)
        {
            console.error(err);
            display_error('error', 'Oops...', 'There seems to be a problem with your data (this might happen if you type text into the weight, reps, sets or maxrep fields), maybe try another exercise!')
        }
    }

    function get_value(json_ex, weight, reps, sets, max_rep) 
    {
        var json = JSON.parse(json_ex);
        var values = [];

        // default values are used if simplified mode is used
        if(document.getElementById("simplify-ui").checked)
        {
            weight  = true;
            reps    = true;
            sets    = true;
            max_rep = false;
            var mul_weight = 1;
            var mul_reps   = 1;
            var mul_sets   = 1;
        }
        else
        {
            var mul_weight = document.getElementById("weight-slider").value;
            var mul_reps   = document.getElementById("reps-slider").value;
            var mul_sets   = document.getElementById("sets-slider").value;
            var mul_max_rep = document.getElementById("maxrep-slider").value;
        }
        
        for(var i = 0; i < json.values.length; i++) 
        {
            // to avoid multiplying * 0
            values[i] = 1;

            // Dont use else if because multiple checkboxes can be checked
            /*if(weight && typeof(json.values[i].weight) != 'undefined' && json.values[i].weight != null && json.values[i].weight.length > 0) // FMI: .length references lengt of string not of an json array
                if(parseFloat(json.values[i].weight.match(/[\d\.]+/)) > 0)
                    values[i] *= parseFloat(json.values[i].weight.match(/[\d\.]+/)) * mul_weight;
            
            if(reps && typeof(json.values[i].reps) != 'undefined' && json.values[i].reps != null && json.values[i].reps.length > 0)
                if(parseFloat(json.values[i].reps.match(/[\d\.]+/)) > 0)
                    values[i] *= parseFloat(json.values[i].reps.match(/[\d\.]+/)) * mul_reps;
            
            if(sets && typeof(json.values[i].sets) != 'undefined' && json.values[i].sets != null && json.values[i].sets.length > 0)
                if(parseFloat(json.values[i].sets.match(/[\d\.]+/)) > 0)
                    values[i] *= parseFloat(json.values[i].sets.match(/[\d\.]+/)) * mul_sets;
            
            if(max_rep && typeof(json.values[i].max_rep) != 'undefined' && json.values[i].max_rep != null && json.values[i].max_rep.length > 0)
                if(parseFloat(json.values[i].max_rep.match(/[\d\.]+/)) > 0)
                    values[i] *= parseFloat(json.values[i].max_rep.match(/[\d\.]+/)) * mul_max_rep;
            */

            if(weight)
                values[i] *= json.values[i].weight * mul_weight;
            
            if(reps)
                values[i] *= json.values[i].reps * mul_reps;
            
            if(sets)
                values[i] *= json.values[i].sets * mul_sets;
            
            if(max_rep)
                values[i] *= json.values[i].max_rep * mul_max_rep;
        }



        return values;
    }

    function addData(values, ex_name, all_ex)
    {
        console.log(values);

        var local_labels_date = [];
        var local_labels_numbers = [];
        var json_ex = JSON.parse(all_ex);

        for(var i = 0; i < json_ex.values.length; i++)
        {
            local_labels_date.push(json_ex.values[i].created);
        }

        chart.data.labels = local_labels_date;

        if(document.getElementById("chart-type").checked == false)
        {    
            chart.data.datasets.push({
                data: values,
                label: ex_name,
                borderColor: border_color_array[num_ex_color],
                backgroundColor: border_color_array[num_ex_color],
                fill: false
            });

            chart.data.labels = local_labels_date;
        }
        else
        {
            chart.data.datasets.push({
                data: values,
                label: ex_name,
                backgroundColor: border_color_array[num_ex_color],
            });
        }   

        if(num_ex_color == border_color_array.length - 1)
            num_ex_color = 0;
        else
            num_ex_color++;

        // needs to be checked before numbers gets increased
        change_div(all_ex, ex_name, false);
    
        
        // needs to be checked before numbers gets increased
        if(num_ex >= 1)
        {
            // Get longest exercise with most entries from chart and store it in a variable
            for(var i = 0; i <= num_ex; i++)
            {
                var data = active_ex_in_chart[i];
                var json = JSON.parse(data);

                local_labels_numbers.push(json.values.length);
            }

            var max_num = Math.max.apply(Math, local_labels_numbers); 

            local_labels_numbers = [];

            for(var i = 1; i <= max_num; i++)
                local_labels_numbers.push(i);

            chart.data.labels = local_labels_numbers;
        }    

        num_ex++;

        

        chart.update({
            duration: 900,
            easing: 'easeInOutCubic'
        });
    }

    function change_div(values, ex_name, reset)
    {
        if(reset)
        {
            document.getElementById("additional-info").innerHTML = "";
            document.getElementById("additional-info").style.width = "0%";
        }
        else
        {
            if(num_ex == 0)
            {
                document.getElementById("additional-info").style.width = "25%";
                document.getElementById("additional-info").innerHTML += "<p style='font-size: 22px; padding-bottom: 6px; color: #00ad5f; margin-right: 10%; margin-left: 10%; margin-bottom: 2%; border-bottom: 4px solid rgba(0,0,0, 0.12); border-right: 4px solid rgba(0,0,0, 0.12); text-align:center; '>4. Check your progress &nbsp <i class='fas fa-info-circle' rel='tooltip' title='Click on one of the exercises to have a detailed view on how your volume changed' id='info-step-4'></i> "
            }    
            
            var json = JSON.parse(values);

            document.getElementById("additional-info").innerHTML = document.getElementById("additional-info").innerHTML + '<button id="' + json.base_ex + '" class="button" style="top: 10px; width:80%; margin-left: 10%;">' + ex_name + '</button>'
            document.getElementById(json.base_ex).setAttribute( "onClick", "Swal.fire({html: '" + parse_base_ex(values, ex_name) + "'});");
        }
    }

    function parse_base_ex(values, ex_name)
    {
        var json = JSON.parse(values);
        var parse = ex_name + "<br><br><br>";

        console.log(json);

        for(var i = 0; i < json.values.length; i++)
        {
            parse += (i + 1) + ". Entry on: " + json.values[i].created + "<br>";
            
            /*if(i > 0)
                if(typeof(json.values[i].weight) != 'undefined' && json.values[i].weight != null)
                    if(parseFloat(json.values[i].weight.match(/[\d\.]+/)) > parseFloat(json.values[i - 1].weight.match(/[\d\.]+/)))
                        parse += '<font color="green">Weight: ' + json.values[i].weight + "</font><br>";
                    else if(parseFloat(json.values[i].weight.match(/[\d\.]+/)) < parseFloat(json.values[i - 1].weight.match(/[\d\.]+/)))
                        parse += '<font color="red">Weight: ' + json.values[i].weight + "</font><br>";
                    else
                        parse += "Weight: " + json.values[i].weight + "<br>";
                else
                    parse += "Weight: " + json.values[i].weight + "<br>";
            else
                parse += "Weight: " + json.values[i].weight + "<br>";
            
            if(i > 0)
                if(typeof(json.values[i].reps) != 'undefined' && json.values[i].reps != null)   
                    if(parseFloat(json.values[i].reps.match(/[\d\.]+/)) > parseFloat(json.values[i - 1].reps.match(/[\d\.]+/)))
                        parse += '<font color="green">Reps: ' + json.values[i].reps + "</font><br>";
                    else if(parseFloat(json.values[i].reps.match(/[\d\.]+/)) < parseFloat(json.values[i - 1].reps.match(/[\d\.]+/)))
                        parse += '<font color="red">Reps: ' + json.values[i].reps + "</font><br>";
                    else
                        parse += "Reps: " + json.values[i].reps + "<br>";
                else
                    parse += "Reps: " + json.values[i].reps + "<br>";
            else
                parse += "Reps: " + json.values[i].reps + "<br>";

            
            if(i > 0)
                if(typeof(json.values[i].sets) != 'undefined' && json.values[i].sets != null)
                    if(json.values[i].sets > json.values[i - 1].sets)
                        parse += '<font color="green">Sets: ' + json.values[i].sets + "</font><br>";
                    else if(json.values[i].sets < json.values[i - 1].sets)
                        parse += '<font color="red">Sets: ' + json.values[i].sets + "</font><br>";
                    else   
                        parse += "Sets: " + json.values[i].sets + "<br>";
                else
                    parse += "Sets: " + json.values[i].sets + "<br>";
            else
                parse += "Sets: " + json.values[i].sets + "<br>";
            
            if(i > 0)
                if(typeof(json.values[i].max_rep) != 'undefined' && json.values[i].max_rep != null)
                    if(json.values[i].max_rep > json.values[i - 1].max_rep)
                        parse += '<font color="green">Max Rep: ' + json.values[i].max_rep + "</font><br>";
                    else if(json.values[i].max_rep < json.values[i - 1].max_rep)
                        parse += '<font color="red">Max Rep: ' + json.values[i].max_rep + "</font><br>";
                    else   
                        parse += "Max Rep: " + json.values[i].max_rep + "<br>";
                else
                    parse += "Max Rep: " + json.values[i].max_rep + "<br>";
            else
                parse += "Max Rep: " + json.values[i].max_rep + "<br>";
            */

            if(i > 0)
                console.log('"' + json.values[i].weight + '"' + ' | ' + '"' + json.values[i - 1].weight + '"');

            if(i > 0)
                if(parseFloat(json.values[i].weight.match(/[\d\.]+/)) > parseFloat(json.values[i - 1].weight.match(/[\d\.]+/)))
                    parse += '<font color="green">Weight: ' + json.values[i].weight + "</font><br>";
                else if(parseFloat(json.values[i].weight.match(/[\d\.]+/)) < parseFloat(json.values[i - 1].weight.match(/[\d\.]+/)))
                    parse += '<font color="red">Weight: ' + json.values[i].weight + "</font><br>"; 
                else
                    parse += "Weight: " + json.values[i].weight + "<br>";
            else
                parse += "Weight: " + json.values[i].weight + "<br>";

            if(i > 0)
                if(parseFloat(json.values[i].reps.match(/[\d\.]+/)) > parseFloat(json.values[i - 1].reps.match(/[\d\.]+/)))
                    parse += '<font color="green">Reps: ' + json.values[i].reps + "</font><br>";
                else if(parseFloat(json.values[i].reps.match(/[\d\.]+/)) < parseFloat(json.values[i - 1].reps.match(/[\d\.]+/)))
                    parse += '<font color="red">Reps: ' + json.values[i].reps + "</font><br>";
                else
                    parse += "Reps: " + json.values[i].reps + "<br>";
            else
                parse += "Reps: " + json.values[i].reps + "<br>";

            
            if(i > 0)
                if(parseFloat(json.values[i].sets.match(/[\d\.]+/)) > parseFloat(json.values[i - 1].sets.match(/[\d\.]+/)))
                    parse += '<font color="green">Sets: ' + json.values[i].sets + "</font><br>";
                else if(parseFloat(json.values[i].sets.match(/[\d\.]+/)) < parseFloat(json.values[i - 1].sets.match(/[\d\.]+/)))
                    parse += '<font color="red">Sets: ' + json.values[i].sets + "</font><br>";
                else   
                    parse += "Sets: " + json.values[i].sets + "<br>";
            else
                parse += "Sets: " + json.values[i].sets + "<br>";
            
            if(i > 0)
                if(parseFloat(json.values[i].max_rep.match(/[\d\.]+/)) > parseFloat(json.values[i - 1].max_rep.match(/[\d\.]+/)))
                    parse += '<font color="green">Max Rep: ' + json.values[i].max_rep + "</font><br>";
                else if(parseFloat(json.values[i].max_rep.match(/[\d\.]+/)) < parseFloat(json.values[i - 1].max_rep.match(/[\d\.]+/)))
                    parse += '<font color="red">Max Rep: ' + json.values[i].max_rep + "</font><br>";
                else   
                    parse += "Max Rep: " + json.values[i].max_rep + "<br>";
            else
                parse += "Max Rep: " + json.values[i].max_rep + "<br>";

            parse += "<br>"

        }

        return parse;
    }

    function clear_chart(clearSelect)
    {
        chart.reset();
        chart.clear();
        chart = create_chart(chart_type);
        
        if(clearSelect)
            document.getElementById("select").selectedIndex = -1;

        change_div(0, 0, true);
        active_ex_in_chart = [];
        num_ex = 0;
        // console.log(num_ex);
    }

    var labels = [1,2,3,4,5,6,7,8];
    var border_color_array = ["#00ad5f", "#E3170A", "#F7B32B", "#8980F5", "#102542", "#0EB1D2", "#41658A", "#A9E5BB", "#1A3A3A", "#0EB1D2"];
    var ex_names = ["kniebeuge", "bankdruecken", "seitheben", "latzug"];

    function get_chart_type()
    {

        return "line";
    }

    function change_chart()
    {
        // Used to change between the two chart types
        if(document.getElementById("chart-type").checked)
            chart_type = "bar";
        else
            chart_type = "line";

        clear_chart(true);

        // TODO
        // write function rebuild chart, that clears chart but not data array and pushes all data back into the new chart
        /*
        var values;

        chart.reset();
        chart.clear();
        chart = create_chart(chart_type);
        
        var weight_box = document.getElementById("weight_box");
        var reps_box = document.getElementById("reps_box");
        var sets_box = document.getElementById("sets_box");
        var max_rep_box = document.getElementById("max_rep_box");

        for(var i = 0; i < chart.data.datasets.length; i++)
        {
            values = get_value(active_ex_in_chart[i], weight_box.checked, reps_box.checked, sets_box.checked, max_rep_box.checked);
            addData(values, chart.data.datasets[i], active_ex_in_chart[i])
        }
        */
    }

    function create_chart(chart_type)
    {
        // Make sure it is created from a clean start
        // clear_chart();

        var chart = new Chart(document.getElementById("line-chart"), {
            type: chart_type,
            data: {
                labels: labels,
                datasets: [
                    
                ]
            },
            options: {
                ticks: {
                    beginAtZero: false,
                    min: 0,
                    max: 5.03,
                    stepSize: 1,
                    padding: 10,
                    fontFamily: 'Karla, sans-serif',
                    maxRotation: 0/*,
                    callback: function(value, index, values) {
                        if (value !== 5.03) {
                            return values[index]
                        }
                    }*/
                },
                title: {
                    display: false,
                    text: 'Trainingsplan'
                },
                legend: {
                    display: true,
                    //position: 'bottom',
                    labels: {
                        fontSize: 20
                    }
                },
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                },
                tooltips: {
                    enabled: true,
                    mode: 'single',
                    callbacks: {
                        label: function(tooltipItems, data) { 
                            var label = data.datasets[tooltipItems.datasetIndex].label || '';
                            get_data_per_exercise_and_step(tooltipItems.xLabel, label);
                            return tooltipItems.xLabel + " | " + label;
                        }
                    }
                },            
                responsive: true,
                maintainAspectRatio: false

            }
         });

         return chart;
        }

    function get_data_per_exercise_and_step(index, name)
    {
        
    }

    function openNav()
    {
        if( isMobile.any() ) 
        {
            document.getElementById("mySidenav").style.width = "300px";
        }
        else
        {
            document.getElementById("mySidenav").style.width = "250px";
        }   
    }

    function closeNav()
    {
        document.getElementById("mySidenav").style.width = "0";
    }

    function save_settings()
    {
        var preferences = {}; 

        preferences.username = getusername(); 
        preferences.check_weight = document.getElementById("weight_box").checked;
        preferences.check_reps = document.getElementById("reps_box").checked;
        preferences.check_sets = document.getElementById("sets_box").checked;
        preferences.check_maxrep = document.getElementById("max_rep_box").checked;
        preferences.check_simple_view = document.getElementById('simplify-ui').checked;
        preferences.check_chart_type  = document.getElementById('chart-type').checked;        
        preferences.check_dialog_save = "ignore";     

        preferences.mul_weight = document.getElementById('weight-slider').value;
        preferences.mul_reps = document.getElementById('reps-slider').value;
        preferences.mul_sets = document.getElementById('sets-slider').value;
        preferences.mul_maxrep = document.getElementById('maxrep-slider').value;

        
        var xhr = new XMLHttpRequest();
        var url = "http://jakob.ml:50003/trainingsplan/send_preferences";
        xhr.open("POST", url, true);
        xhr.setRequestHeader("Content-Type", "text/plain");
        var string = JSON.stringify(preferences);

        console.log()

        xhr.send(string);
        //alert("Preferences saved!");
    }

    var isMobile = {
        Android: function() {
            return navigator.userAgent.match(/Android/i);
        },
        BlackBerry: function() {
            return navigator.userAgent.match(/BlackBerry/i);
        },
        iOS: function() {
            return navigator.userAgent.match(/iPhone|iPad|iPod/i);
        },
        Opera: function() {
            return navigator.userAgent.match(/Opera Mini/i);
        },
        Windows: function() {
            return navigator.userAgent.match(/IEMobile/i) || navigator.userAgent.match(/WPDesktop/i);
        },
        any: function() {
            return (isMobile.Android() || isMobile.BlackBerry() || isMobile.iOS() || isMobile.Opera() || isMobile.Windows());
        }
    };

    function customize_mobile()
    {
        document.getElementById("headerforbuttons").style.height = "75px";
        chart.options.legend.labels.fontSize = 30;
        document.getElementById("weight-slider").style.width = "90%";
        document.getElementById("reps-slider").style.width = "90%";
        document.getElementById("sets-slider").style.width = "90%";
        document.getElementById("maxrep-slider").style.width = "90%";

        /*
        document.getElementById("weight-slider").style.height = "2.5%";
        document.getElementById("reps-slider").style.height = "2.5%";
        document.getElementById("sets-slider").style.height = "2.5%";
        document.getElementById("maxrep-slider").style.height = "2.5%";
        */

        document.getElementById("weight-slider").style.float = "left";
        document.getElementById("reps-slider").style.float = "left";
        document.getElementById("sets-slider").style.float = "left";
        document.getElementById("maxrep-slider").style.float = "left";

        //document.getElementById("weight-slider-div").style.padding = "200px"; doesnt need as it is the first
        document.getElementById("reps-slider-div").style.marginTop = "80px";
        document.getElementById("sets-slider-div").style.marginTop = "80px";
        document.getElementById("max-slider-div").style.marginTop = "80px";

        document.getElementById("max-slider-div").style.marginTop = "80px";


        var buttons = document.getElementsByTagName("button");
        for(var i = 0, il = buttons.length; i < il; i++)
        {
            buttons[i].className += " mobile_button";
        }

        var spans = document.getElementsByTagName("span");
        for(var i = 0, il = spans.length; i < il; i++)
        {
            spans[i].className += " mobile_span";
        }

        var ps = document.getElementsByTagName("p");
        for(var i = 0, il = ps.length; i < il; i++)
        {
            ps[i].className += " mobile_p";
        }

        var labels = document.getElementsByTagName("label");
        for(var i = 0, il = labels.length; i < il; i++)
        {
            //labels[i].className += " mobile_label";
        }
    }

    function simplify_ui()
    {
        document.getElementById("checks-checkbox-ui").checked = false;
        document.getElementById("factors-checkbox-ui").checked = false;

        if(document.getElementById("simplify-ui").checked)
        {          
            // document.getElementById("selects").style.width = "30%";
            document.getElementById("selects").style.marginLeft = "38%";

            document.getElementById("checks").style.display = "none";
            document.getElementById("factors").style.display = "none";
            //  document.getElementById("additional-info").style.display = "none";
        }    
        else
        {
            document.getElementById("selects").style.marginLeft = "5%";

            document.getElementById("checks").style.display = "inline";
            document.getElementById("factors").style.display = "inline";
            document.getElementById("additional-info").style.display = "inline";
            
            document.getElementById("checks-checkbox-ui").checked = true;
            document.getElementById("factors-checkbox-ui").checked = true;
        }    
    }

    function simplify_ui_partly()
    {
        // As i activate some part of the advanced ui, it is no longer the simplified view, so deactivate it
        document.getElementById("simplify-ui").checked = false;

        // If both are checked, use the simplify_ui function to set everything back to normal, but activate the buttons to make it look 
        if(document.getElementById("checks-checkbox-ui").checked && document.getElementById("factors-checkbox-ui").checked)
        {
            document.getElementById("simplify-ui").checked = false;
            simplify_ui();
        }
        else if(document.getElementById("checks-checkbox-ui").checked && !document.getElementById("factors-checkbox-ui").checked)
        {
            // document.getElementById("selects").style.width = "30%";
            document.getElementById("selects").style.marginLeft = "10%";

            document.getElementById("checks").style.display = "inline";
            document.getElementById("factors").style.display = "none";
        }    
        else if(!document.getElementById("checks-checkbox-ui").checked && document.getElementById("factors-checkbox-ui").checked)
        {
            // document.getElementById("selects").style.width = "30%";
            document.getElementById("selects").style.marginLeft = "10%";

            document.getElementById("checks").style.display = "none";
            document.getElementById("factors").style.display = "inline";
        }
        else 
        {
            document.getElementById("simplify-ui").checked = false;

            document.getElementById("selects").style.marginLeft = "5%";

            document.getElementById("checks").style.display = "inline";
            document.getElementById("factors").style.display = "inline";
            document.getElementById("additional-info").style.display = "inline";
        } 
    }

    /*
    document.addEventListener('DOMContentLoaded', function()
    {
        var available_ex;
        var check = function()
        {
            if(getusername().length > 0){
                
                available_ex = get_available_ex();            
                append_combo(available_ex);
                data = append_preferences();

                if(data.check_chart_type == 'f')
                {
                    chart_type = 'line';
                    chart = create_chart(chart_type);
                }    
                else
                {
                    chart_type = 'bar';
                    chart = create_chart(chart_type);
                }


                if( isMobile.any() ) 
                    customize_mobile();
                else
                    ;
            }
            else
            {
                setTimeout(check, 10); // check again in 10 ms
            }
        }
        
        check();

        
    }, false);
    */
</script>
</html>