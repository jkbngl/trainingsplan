<html>
<head>
    <title>trainigsplan</title>

    <style>
        .mobile_size button.mobile_button,  button.mobile_button {
           font-size: 30px;
        }

        .mobile_p p.mobile_p,  p.mobile_p {
           font-size: 30px;
        }

        .mobile_span span.mobile_span,  span.mobile_span {
           font-size: 30px;
        }

        .mobile_label label.mobile_label,  label.mobile_label {
           font-size: 30px;
        }
    </style>

    <link rel="stylesheet" type="text/css" href="css/main.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.1/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>



    <script src="http://jakob.ml:8081/auth/js/keycloak.js"></script> 
    <script>
        
        var keycloak = Keycloak();

        keycloak.init({ onLoad: 'login-required' })

        keycloak.init().success(
            function(authenticated) 
            {
                // alert(authenticated ? 'authenticated' : 'not authenticated');
            }
        ).error(function() 
        {
            // alert('failed to initialize');
        }
        );

        keycloak.onAuthSuccess = function() 
        { 
            // alert('Successfully authenticated'); 
            console.log('Successfully authenticated'); 

            username = keycloak.idTokenParsed.name;
            document.getElementById("username").innerHTML = username + ' <i class="fas fa-sign-out-alt"></i>';
            console.log(username);  
        }

        function getusername()
        {
            return username;
        }
    </script>
</head>
<body>
    <div class="fixed-background blue-gradient-bg"></div>

    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()"><i class="fas fa-bars"></i></a>
        <!--<a href="#">About</a>-->
        <!--<button onclick="receivePlanfromDB(false)" class="button" style=" top: 10px; width:80%; margin-left: 10%;">Load Plan</button>
        <button onclick="cleanUpTables(); addTable(true);  closeNav();"class="button" style="top: 10px; width:80%; margin-left: 10%;">New Plan</button>-->
        <button onclick="window.location.href='index.html'" class="button" style="top: 10px; width:80%; margin-left: 10%;"><i class="fas fa-home"></i> Home</button>
        <button onclick="closeNav();"class="button" style="top: 10px; width:80%; margin-left: 10%;"><i class="fas fa-cog"></i> Settings</button>
        <button onclick="download();" class="button" style="top: 10px; width:80%; margin-left: 10%;"><i class="fas fa-file-export"></i> Export</button>
        <button onclick="keycloak.logout('/trainingsplanorwhateveritdoesntworkanyway'); kc.logout()"class="button" style="top: 10px; width:80%; margin-left: 10%;"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>

    <div id = "headerforbuttons" style="display: flex; justify-content: space-between; position:fixed; width:100%">
        <button onclick="openNav()" class="button" style="top: 10px;"><i class="fas fa-bars"></i></span>
            <!-- <button onclick="addTable(true)" class="button" style="top: 10px;">Add new Day</button>-->
            <button onclick="window.location.href='index.html'" class="button" style="top: 10px;" ><i class="fas fa-home"></i> Home</button>
            <button onclick="closeNav(); clear_chart()" class="button" style="top: 10px;" ><i class="fas fa-trash"></i> Clear</button>
            <button onclick="keycloak.logout()" class="button" value="username ..." id="username" style="top: 10px;"></button>
    </div>â€‹

    <div>
        <canvas id="line-chart" height="100" ></canvas>
    </div>

	<div class="divOuter"  >
        <div class="select divInner1"  style="margin-top: 70px; margin-right: 100px;">
            <select id= "select" onchange="closeNav(); display_ex();" class="select-text" required>
                <option value="" selected></option>
            </select>
            <span class="select-highlight"></span>
            <span class="select-bar"></span>
            <label class="select-label">Analyse an exercise</label>
        </div>



        <div class="divInner2">
            <p class="param_top">Choose the &nbsp

            <p class="param_bottom">parameter/s &nbsp
                             
            <div class="page__toggle" style="margin-top: 10px;">
                <label class="toggle">
                  <input id="weight_box" onchange="closeNav();" class="toggle__input" type="checkbox" checked>
                  <span class="toggle__label">
                    <span class="toggle__text">Weight</span>
                  </span>
                </label>
            </div>
            <div class="page__toggle"  style="margin-top: 10px;">
                <label class="toggle">
                  <input id="reps_box" onchange="closeNav();" class="toggle__input" type="checkbox" checked>
                  <span class="toggle__label">
                    <span class="toggle__text">Reps</span>
                  </span>
                </label>
            </div>
            <div class="page__toggle"  style="margin-top: 10px;">
                <label class="toggle">
                  <input id="sets_box" onchange="closeNav();" class="toggle__input" type="checkbox" checked>
                  <span class="toggle__label">
                    <span class="toggle__text">Sets</span>
                  </span>
                </label>
            </div>
            <div class="page__toggle" style="margin-top: 10px;">
                <label class="toggle">
                  <input id="max_rep_box" onchange="closeNav();" class="toggle__input" type="checkbox">
                  <span class="toggle__label">
                    <span class="toggle__text">Max Rep</span>
                  </span>
                </label>
            </div>
        </div>
    </div>
          
    
    
</body>

<script>
    var num_ex = 0;

    function download() 
    {
        var url_base64 = document.getElementById('line-chart').toDataURL('image/png');
        var element = document.createElement('a');
        
        element.setAttribute('href', url_base64);
        element.setAttribute('download', 'chart.png');
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    }
    

    function get_available_ex()
    {
        var request = new XMLHttpRequest();
        var url = 'http://jakob.ml:50003/trainingsplan/get_possible_base_exs/';
        var username = getusername();
        var xmlHttp = new XMLHttpRequest();

        xmlHttp.open( "GET", url + username, false ); // false for synchronous request
        xmlHttp.send( null );
        available_ex = xmlHttp.responseText;

        return available_ex;
    }

    function append_combo(json_base_exs)
    {
        var json = JSON.parse(json_base_exs);
        var exercises = document.getElementById('select');

        for(var i = 0; i < json.base_exs.length; i++) 
        {
            var opt = document.createElement('option');
            opt.value = json.base_exs[i].base_ex;
            opt.innerHTML = json.base_exs[i].name + " - " + json.base_exs[i].planname;
            opt.id = 'option_element';
            exercises.appendChild(opt);
        }
    }

    function display_ex() {
        var values = [];
        var e = document.getElementById("select");
        var value = e.options[e.selectedIndex].value;
        var text = e.options[e.selectedIndex].text;

        console.log(text + " | " + value)

        var request = new XMLHttpRequest();
        var url = 'http://jakob.ml:50003/trainingsplan/get_stats/';
        var xmlHttp = new XMLHttpRequest();

        xmlHttp.open( "GET", url + value, false ); // false for synchronous request
        xmlHttp.send( null );
        available_ex = xmlHttp.responseText;

        var weight_box = document.getElementById("weight_box");
        var reps_box = document.getElementById("reps_box");
        var sets_box = document.getElementById("sets_box");
        var max_rep_box = document.getElementById("max_rep_box");

        values = get_value(available_ex, weight_box.checked, reps_box.checked, sets_box.checked, max_rep_box.checked);

        addData(values, text);
    }

    function get_value(json_ex, weight, reps, sets, max_rep) {

        var json = JSON.parse(json_ex);
        var values = [];
        
        for(var i = 0; i < json.values.length; i++) 
        {
            // to avoid multiplying * 0
            values[i] = 1;

            if(weight && json.values[i].weight > 0)
                values[i] *= json.values[i].weight;
            if(reps && json.values[i].reps > 0)    
                values[i] *= json.values[i].reps;
            if(sets && json.values[i].sets > 0)
                values[i] *=  json.values[i].sets;
            if(max_rep && json.values[i].reps > 0)
                values[i] *= json.values[i].max_rep;
        }

        return values;
    }

    function addData(values, ex_name) {

        chart.data.datasets.push({
            data: values,
            label: ex_name,
            borderColor: border_color_array[num_ex],
            fill: false
        });

        if(num_ex == border_color_array.length - 1)
            num_ex = 0;
        else
            num_ex++;

        chart.update();
    }

    function clear_chart()
    {
        chart.reset();
        chart.clear();
        chart = create_chart();
    }

    var labels = [1.1,1.2,1.3,1.4,2.1,2.2,2.3,2.4];
    var border_color_array = ["#00ad5f", "#E3170A", "#F7B32B", "#8980F5", "#102542", "#0EB1D2", "#41658A", "#A9E5BB", "#1A3A3A", "#0EB1D2"];
    var ex_names = ["kniebeuge", "bankdruecken", "seitheben", "latzug"];

    var chart = create_chart();

    function create_chart()
    {
        var chart = new Chart(document.getElementById("line-chart"), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    
                ]
            },
            options: {
                title: {
                    display: true,
                    //text: 'Trainingsplan',
                    responsive: true
                }
            }
         });

         return chart;
    }

    function openNav()
    {
        document.getElementById("mySidenav").style.width = "250px";
    }

    function closeNav()
    {
        document.getElementById("mySidenav").style.width = "0";
    }

    var isMobile = {
        Android: function() {
            return navigator.userAgent.match(/Android/i);
        },
        BlackBerry: function() {
            return navigator.userAgent.match(/BlackBerry/i);
        },
        iOS: function() {
            return navigator.userAgent.match(/iPhone|iPad|iPod/i);
        },
        Opera: function() {
            return navigator.userAgent.match(/Opera Mini/i);
        },
        Windows: function() {
            return navigator.userAgent.match(/IEMobile/i) || navigator.userAgent.match(/WPDesktop/i);
        },
        any: function() {
            return (isMobile.Android() || isMobile.BlackBerry() || isMobile.iOS() || isMobile.Opera() || isMobile.Windows());
        }
    };

    function customize_mobile()
    {
        document.getElementById("headerforbuttons").style.height = "75px";

        var buttons = document.getElementsByTagName("button");
        for(var i = 0, il = buttons.length; i < il; i++)
        {
            buttons[i].className += " mobile_button";
        }

        var spans = document.getElementsByTagName("span");
        for(var i = 0, il = spans.length; i < il; i++)
        {
            spans[i].className += " mobile_span";
        }

        var ps = document.getElementsByTagName("p");
        for(var i = 0, il = ps.length; i < il; i++)
        {
            ps[i].className += " mobile_p";
        }

        var labels = document.getElementsByTagName("label");
        for(var i = 0, il = labels.length; i < il; i++)
        {
            labels[i].className += " mobile_label";
        }
    }

    document.addEventListener('DOMContentLoaded', function()
    {
        var available_ex;
        var check = function()
        {
            if(getusername().length > 0){
                available_ex = get_available_ex();            
                append_combo(available_ex);
            }
            else
            {
                setTimeout(check, 10); // check again in 10 ms
            }
        }
        
        check();
        if( isMobile.any() ) 
        {
            console.log("MOBILE DETECTED AS DEVICE");
            customize_mobile();
        }
        else
        {
            //customize_mobile();
            console.log("PC DETECTED AS DEVICE");
        }
    }, false);
</script>
</html>